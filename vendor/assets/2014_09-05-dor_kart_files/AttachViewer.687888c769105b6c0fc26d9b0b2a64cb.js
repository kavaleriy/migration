window.define=window.define||function(name,deps,callback){(callback||deps||name)()};
(function(jQuery){var $=jQuery;(function(){var x=Function("return this")();if(!x.fest)x.fest={};x.fest["pages/attachviewer/attachviewer__archive__tree"]=function(__fest_context){var __fest_self=this,__fest_buf=[],__fest_chunks=[],__fest_chunk,__fest_attrs=[],__fest_select,__fest_if,__fest_iterator,__fest_to,__fest_fn,__fest_html=[],__fest_blocks={},__fest_params,__fest_element,__fest_debug_file="",__fest_debug_line="",__fest_debug_block="",__fest_htmlchars=/[&<>"]/g,__fest_htmlchars_test=/[&<>"]/,
__fest_short_tags={"area":true,"base":true,"br":true,"col":true,"command":true,"embed":true,"hr":true,"img":true,"input":true,"keygen":true,"link":true,"meta":true,"param":true,"source":true,"wbr":true},__fest_element_stack=[],__fest_htmlhash={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"},__fest_jschars=/[\\'"\/\n\r\t\b\f<>]/g,__fest_jschars_test=/[\\'"\/\n\r\t\b\f<>]/,__fest_jshash={'"':'\\"',"\\":"\\\\","/":"\\/","\n":"\\n","\r":"\\r","\t":"\\t","\b":"\\b","\f":"\\f","'":"\\'","<":"\\u003C",">":"\\u003E"},
___fest_log_error;if(typeof __fest_error==="undefined")___fest_log_error=typeof console!=="undefined"&&console.error?function(){return Function.prototype.apply.call(console.error,console,arguments)}:function(){};else ___fest_log_error=__fest_error;function __fest_log_error(msg){___fest_log_error(msg+'\nin block "'+__fest_debug_block+'" at line: '+__fest_debug_line+"\nfile: "+__fest_debug_file)}function __fest_replaceHTML(chr){return __fest_htmlhash[chr]}function __fest_replaceJS(chr){return __fest_jshash[chr]}
function __fest_extend(dest,src){for(var i in src)if(src.hasOwnProperty(i))dest[i]=src[i]}function __fest_param(fn){fn.param=true;return fn}function __fest_call(fn,params,cp){if(cp)for(var i in params)if(typeof params[i]=="function"&&params[i].param)params[i]=params[i]();return fn.call(__fest_self,params)}function __fest_escapeJS(s){if(typeof s==="string"){if(__fest_jschars_test.test(s))return s.replace(__fest_jschars,__fest_replaceJS)}else if(typeof s==="undefined")return"";return s}function __fest_escapeHTML(s){if(typeof s===
"string"){if(__fest_htmlchars_test.test(s))return s.replace(__fest_htmlchars,__fest_replaceHTML)}else if(typeof s==="undefined")return"";return s}var json=__fest_context;(function(__fest_context){(function(__fest_context){__fest_blocks.messagelist_fileslist_short__files=function(params){var __fest_buf=[];__fest_buf.push('<div class="messagelist_fileslist_short__files">');var i,file,__fest_iterator0;try{__fest_iterator0=params.list()||{}}catch(e){__fest_iterator={};__fest_log_error(e.message)}for(i in __fest_iterator0){file=
__fest_iterator0[i];try{__fest_if=file.isFolder}catch(e){__fest_if=false;__fest_log_error(e.message)}if(__fest_if){__fest_buf.push('<div class="messageline messagelist_fileslist_short__files__file messagelist_fileslist_short__files__file_folder">');try{__fest_attrs[0]=__fest_escapeHTML(json.lang.blocks.messagelist.fileslist_short.files.show_source)}catch(e){__fest_attrs[0]="";__fest_log_error(e.message)}try{__fest_attrs[1]=__fest_escapeHTML(json.lang.blocks.messagelist.fileslist_short.files.show_source)}catch(e){__fest_attrs[1]=
"";__fest_log_error(e.message)}try{__fest_attrs[2]=__fest_escapeHTML(json.lang.blocks.messagelist.fileslist_short.files.hide_source)}catch(e){__fest_attrs[2]="";__fest_log_error(e.message)}try{__fest_attrs[3]=__fest_escapeHTML(file.id)}catch(e){__fest_attrs[3]="";__fest_log_error(e.message)}__fest_buf.push('<span class="messageline__body js-toggle-folder" title="'+__fest_attrs[0]+'" data-show-title="'+__fest_attrs[1]+'" data-hide-title="'+__fest_attrs[2]+'" data-id="'+__fest_attrs[3]+'"><span class="messageline__body__link messageline__body__link_filename"><span class="messageline__flag"><i class="messageline__filetype__icon icon_filetype icon_filetype_folder"></i></span><span class="messageline__body__subject attachviewer__viewer__name__filename">');
try{__fest_buf.push(__fest_escapeHTML(file.name))}catch(e){__fest_log_error(e.message+"16")}__fest_buf.push('</span></span></span><div class="messagelist_fileslist_short__files__wrapper"></div></div>')}else{__fest_buf.push('<div class="messageline messagelist_fileslist_short__files__file"><span class="messageline__body">');try{__fest_if=file.size<32*Math.MB}catch(e){__fest_if=false;__fest_log_error(e.message)}if(__fest_if){try{__fest_attrs[0]=__fest_escapeHTML(file.index)}catch(e){__fest_attrs[0]=
"";__fest_log_error(e.message)}try{__fest_attrs[1]=__fest_escapeHTML(file.downloadFromZipUrl)}catch(e){__fest_attrs[1]="";__fest_log_error(e.message)}__fest_buf.push('<a data-index="'+__fest_attrs[0]+'" class="messageline__body__link messageline__body__link_filename js-show" href="'+__fest_attrs[1]+'"><span class="messageline__flag">');try{__fest_attrs[0]=__fest_escapeHTML(file.type)}catch(e){__fest_attrs[0]="";__fest_log_error(e.message)}__fest_buf.push('<i class="messageline__filetype__icon icon_filetype icon_filetype_'+
__fest_attrs[0]+'"></i></span><span class="messageline__body__subject attachviewer__viewer__name__filename">');try{__fest_buf.push(__fest_escapeHTML(file.name.replace(/\.[^.]+$/,"")))}catch(e){__fest_log_error(e.message+"36")}__fest_buf.push('</span><span class="attachviewer__viewer__name__filetype">');try{__fest_buf.push(__fest_escapeHTML(file.name.replace(/.+?(\.[^.]+)$/,"$1")))}catch(e){__fest_log_error(e.message+"39")}__fest_buf.push("</span></a>");try{__fest_attrs[0]=__fest_escapeHTML(file.index)}catch(e){__fest_attrs[0]=
"";__fest_log_error(e.message)}try{__fest_attrs[1]=__fest_escapeHTML(file.downloadFromZipUrl)}catch(e){__fest_attrs[1]="";__fest_log_error(e.message)}try{__fest_attrs[2]=__fest_escapeHTML(json.lang.blocks.messagelist.fileslist_short.files.download)}catch(e){__fest_attrs[2]="";__fest_log_error(e.message)}__fest_buf.push('<a data-index="'+__fest_attrs[0]+'" class="messageline__body__link messageline__body__link_filedownload js-downloadLink" href="'+__fest_attrs[1]+'" title="'+__fest_attrs[2]+'"><span><i class="messageline__status__icon icon icon_filedownload"></i></span><span class="messageline__body__filesize">');
try{__fest_buf.push(__fest_escapeHTML(file.humanSize.size))}catch(e){__fest_log_error(e.message+"49")}__fest_buf.push(" ");try{__fest_buf.push(__fest_escapeHTML(json.lang.blocks.messagelist.fileslist_short.files.human_size[file.humanSize.unit]))}catch(e){__fest_log_error(e.message+"51")}__fest_buf.push("</span></a>")}else{__fest_buf.push('<span class="messageline__body__nolink messageline__body__nolink_filename"><span class="messageline__flag">');try{__fest_attrs[0]=__fest_escapeHTML(file.type)}catch(e){__fest_attrs[0]=
"";__fest_log_error(e.message)}__fest_buf.push('<i class="messageline__filetype__icon icon_filetype icon_filetype_'+__fest_attrs[0]+'"></i></span><span class="messageline__body__subject attachviewer__viewer__name__filename">');try{__fest_buf.push(__fest_escapeHTML(file.name.replace(/\.[^.]+$/,"")))}catch(e){__fest_log_error(e.message+"63")}__fest_buf.push('</span><span class="attachviewer__viewer__name__filetype">');try{__fest_buf.push(__fest_escapeHTML(file.name.replace(/.+?(\.[^.]+)$/,"$1")))}catch(e){__fest_log_error(e.message+
"66")}__fest_buf.push('</span></span><span class="messageline__body__nolink messageline__body__nolink_filedownload"><span class="messageline__body__filesize">');try{__fest_buf.push(__fest_escapeHTML(file.humanSize.size))}catch(e){__fest_log_error(e.message+"72")}__fest_buf.push(" ");try{__fest_buf.push(__fest_escapeHTML(json.lang.blocks.messagelist.fileslist_short.files.human_size[file.humanSize.unit]))}catch(e){__fest_log_error(e.message+"74")}__fest_buf.push("</span></span>")}__fest_buf.push("</span></div>")}}__fest_buf.push("</div>");
return __fest_buf.join("")}})(__fest_context);__fest_blocks.messagelist_fileslist_short=function(params){var __fest_buf=[];__fest_buf.push('<div class="messagelist-wrapper messagelist-wrapper_fileslist_short"><div class="messagelist messagelist_fileslist_short"><div>');__fest_select="messagelist_fileslist_short__files";__fest_params={};try{__fest_params=params.root()}catch(e){__fest_log_error(e.message)}__fest_fn=__fest_blocks[__fest_select];if(__fest_fn)__fest_buf.push(__fest_call(__fest_fn,__fest_params,
false));__fest_buf.push("</div></div></div>");return __fest_buf.join("")}})(__fest_context);__fest_select="messagelist_fileslist_short";__fest_params={};try{__fest_params=json.files}catch(e){__fest_log_error(e.message)}__fest_chunks.push(__fest_buf.join(""),{name:__fest_select,params:__fest_params,cp:false});__fest_buf=[];__fest_to=__fest_chunks.length;if(__fest_to){__fest_iterator=0;for(;__fest_iterator<__fest_to;__fest_iterator++){__fest_chunk=__fest_chunks[__fest_iterator];if(typeof __fest_chunk===
"string")__fest_html.push(__fest_chunk);else{__fest_fn=__fest_blocks[__fest_chunk.name];if(__fest_fn)__fest_html.push(__fest_call(__fest_fn,__fest_chunk.params,__fest_chunk.cp))}}__fest_html.push(__fest_buf.join(""));return __fest_html.join("")}else return __fest_buf.join("")};if(x.jsLoader!==undefined&&x.jsLoader.loaded!==undefined&&typeof x.jsLoader.loaded==="function")x.jsLoader.loaded("{festTemplate}pages/attachviewer/attachviewer__archive__tree")})();(function(){var x=Function("return this")();
if(!x.fest)x.fest={};x.fest["pages/attachviewer/attachviewer__archive"]=function(__fest_context){var __fest_self=this,__fest_buf=[],__fest_chunks=[],__fest_chunk,__fest_attrs=[],__fest_select,__fest_if,__fest_iterator,__fest_to,__fest_fn,__fest_html=[],__fest_blocks={},__fest_params,__fest_element,__fest_debug_file="",__fest_debug_line="",__fest_debug_block="",__fest_htmlchars=/[&<>"]/g,__fest_htmlchars_test=/[&<>"]/,__fest_short_tags={"area":true,"base":true,"br":true,"col":true,"command":true,"embed":true,
"hr":true,"img":true,"input":true,"keygen":true,"link":true,"meta":true,"param":true,"source":true,"wbr":true},__fest_element_stack=[],__fest_htmlhash={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"},__fest_jschars=/[\\'"\/\n\r\t\b\f<>]/g,__fest_jschars_test=/[\\'"\/\n\r\t\b\f<>]/,__fest_jshash={'"':'\\"',"\\":"\\\\","/":"\\/","\n":"\\n","\r":"\\r","\t":"\\t","\b":"\\b","\f":"\\f","'":"\\'","<":"\\u003C",">":"\\u003E"},___fest_log_error;if(typeof __fest_error==="undefined")___fest_log_error=typeof console!==
"undefined"&&console.error?function(){return Function.prototype.apply.call(console.error,console,arguments)}:function(){};else ___fest_log_error=__fest_error;function __fest_log_error(msg){___fest_log_error(msg+'\nin block "'+__fest_debug_block+'" at line: '+__fest_debug_line+"\nfile: "+__fest_debug_file)}function __fest_replaceHTML(chr){return __fest_htmlhash[chr]}function __fest_replaceJS(chr){return __fest_jshash[chr]}function __fest_extend(dest,src){for(var i in src)if(src.hasOwnProperty(i))dest[i]=
src[i]}function __fest_param(fn){fn.param=true;return fn}function __fest_call(fn,params,cp){if(cp)for(var i in params)if(typeof params[i]=="function"&&params[i].param)params[i]=params[i]();return fn.call(__fest_self,params)}function __fest_escapeJS(s){if(typeof s==="string"){if(__fest_jschars_test.test(s))return s.replace(__fest_jschars,__fest_replaceJS)}else if(typeof s==="undefined")return"";return s}function __fest_escapeHTML(s){if(typeof s==="string"){if(__fest_htmlchars_test.test(s))return s.replace(__fest_htmlchars,
__fest_replaceHTML)}else if(typeof s==="undefined")return"";return s}var json=__fest_context;(function(__fest_context){__fest_blocks.attaches__archive=function(params){var __fest_buf=[];__fest_buf.push('<div class="attachviewer__toolbar attachviewer__toolbar_top">');try{__fest_attrs[0]=__fest_escapeHTML(params.mail.Id)}catch(e){__fest_attrs[0]="";__fest_log_error(e.message)}__fest_buf.push('<a class="attachviewer__toolbar__subject js-subject" href="/message/'+__fest_attrs[0]+'/" target="_blank"><span class="attachviewer__toolbar__subject__link">');
try{__fest_buf.push(__fest_escapeHTML(params.mail.FromShort))}catch(e){__fest_log_error(e.message+"6")}__fest_buf.push('</span><span class="attachviewer__toolbar__subject__text">&nbsp;&nbsp;&nbsp;&nbsp;');try{__fest_buf.push(__fest_escapeHTML(params.mail.Subject))}catch(e){__fest_log_error(e.message+"10")}__fest_buf.push('</span></a></div><div class="attachviewer__viewer attachviewer__viewer_archive js-archive-viewer">');try{__fest_attrs[0]=__fest_escapeHTML(params.file.iconType)}catch(e){__fest_attrs[0]=
"";__fest_log_error(e.message)}__fest_buf.push('<div class="attachviewer__viewer__icon attachviewer__viewer__icon_'+__fest_attrs[0]+' js-event-attachViewerPreviewDownloadClick.attachViewer js-downloadLink"></div><div class="attachviewer__viewer__info"><div class="attachviewer__viewer__name"><span class="attachviewer__viewer__name__filename">');try{__fest_buf.push(__fest_escapeHTML(params.file.name.replace(/\.[^.]+$/,"")))}catch(e){__fest_log_error(e.message+"21")}__fest_buf.push('</span><span class="attachviewer__viewer__name__filetype">');
try{__fest_buf.push(__fest_escapeHTML(params.file.name.replace(/.+?(\.[^.]+)$/,"$1")))}catch(e){__fest_log_error(e.message+"25")}__fest_buf.push('</span></div><div class="attachviewer__viewer__size">');try{__fest_buf.push(__fest_escapeHTML(String.sizeFormat(params.file.size)))}catch(e){__fest_log_error(e.message+"30")}__fest_buf.push("</div><div>");try{__fest_attrs[0]=__fest_escapeHTML(params.file.downloadUrl)}catch(e){__fest_attrs[0]="";__fest_log_error(e.message)}__fest_buf.push('<a href="'+__fest_attrs[0]+
'" class="attachviewer__toolbar__link js-event-attachViewerPreviewDownloadClick.attachViewer js-downloadLink">');try{__fest_if=patron.NewAttachViewerPopup}catch(e){__fest_if=false;__fest_log_error(e.message)}if(__fest_if){__fest_buf.push('<span class="attachviewer__toolbar__text">');try{__fest_buf.push(__fest_escapeHTML(json.lang.blocks.attaches.archive.download))}catch(e){__fest_log_error(e.message+"38")}__fest_buf.push('</span><i class="icon icon_folders icon_filedownload"></i>')}else{__fest_buf.push('<i class="icon icon_attachview icon_attachview_download"></i>&nbsp;<span class="attachviewer__toolbar__text">');
try{__fest_buf.push(__fest_escapeHTML(json.lang.blocks.attaches.archive.download))}catch(e){__fest_log_error(e.message+"50")}__fest_buf.push("</span>")}__fest_buf.push("</a>");try{__fest_if=patron.EnableAttachToCloud&&!params.file.disableAttachToCloud}catch(e){__fest_if=false;__fest_log_error(e.message)}if(__fest_if){__fest_buf.push('<div style="margin-top: 5px;">');try{__fest_attrs[0]=__fest_escapeHTML(params.file.PartID)}catch(e){__fest_attrs[0]="";__fest_log_error(e.message)}try{__fest_attrs[1]=
__fest_escapeHTML(params.file.name)}catch(e){__fest_attrs[1]="";__fest_log_error(e.message)}__fest_buf.push('<a href="#" data-id="'+__fest_attrs[0]+'" data-filename="'+__fest_attrs[1]+'" class="js-attachToCloud attachviewer__toolbar__link"><span class="attachviewer__toolbar__text">');try{__fest_buf.push(__fest_escapeHTML(json.lang.blocks.attaches.other.to_cloud))}catch(e){__fest_log_error(e.message+"59")}__fest_buf.push('</span><i class="icon icon_attach-to-cloud"></i></a></div>')}__fest_buf.push('</div><div><span class="attachviewer__toolbar__link js-ViewSource attachviewer__viewer__show-source">');
try{__fest_buf.push(__fest_escapeHTML(json.lang.blocks.attaches.archive.view_source))}catch(e){__fest_log_error(e.message+"69")}__fest_buf.push(' <i class="icon icon_loader"></i></span><span class="attachviewer__viewer__error js-error" style="display: none;"></span></div></div></div><div class="attachviewer__viewer__archive-files"></div>');return __fest_buf.join("")}})(__fest_context);__fest_select="attaches__archive";__fest_params={};try{__fest_params=json}catch(e){__fest_log_error(e.message)}__fest_chunks.push(__fest_buf.join(""),
{name:__fest_select,params:__fest_params,cp:false});__fest_buf=[];__fest_to=__fest_chunks.length;if(__fest_to){__fest_iterator=0;for(;__fest_iterator<__fest_to;__fest_iterator++){__fest_chunk=__fest_chunks[__fest_iterator];if(typeof __fest_chunk==="string")__fest_html.push(__fest_chunk);else{__fest_fn=__fest_blocks[__fest_chunk.name];if(__fest_fn)__fest_html.push(__fest_call(__fest_fn,__fest_chunk.params,__fest_chunk.cp))}}__fest_html.push(__fest_buf.join(""));return __fest_html.join("")}else return __fest_buf.join("")};
if(x.jsLoader!==undefined&&x.jsLoader.loaded!==undefined&&typeof x.jsLoader.loaded==="function")x.jsLoader.loaded("{festTemplate}pages/attachviewer/attachviewer__archive")})();(function(){var x=Function("return this")();if(!x.fest)x.fest={};x.fest["pages/attachviewer/attachviewer__image"]=function(__fest_context){var __fest_self=this,__fest_buf=[],__fest_chunks=[],__fest_chunk,__fest_attrs=[],__fest_select,__fest_if,__fest_iterator,__fest_to,__fest_fn,__fest_html=[],__fest_blocks={},__fest_params,
__fest_element,__fest_debug_file="",__fest_debug_line="",__fest_debug_block="",__fest_htmlchars=/[&<>"]/g,__fest_htmlchars_test=/[&<>"]/,__fest_short_tags={"area":true,"base":true,"br":true,"col":true,"command":true,"embed":true,"hr":true,"img":true,"input":true,"keygen":true,"link":true,"meta":true,"param":true,"source":true,"wbr":true},__fest_element_stack=[],__fest_htmlhash={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"},__fest_jschars=/[\\'"\/\n\r\t\b\f<>]/g,__fest_jschars_test=/[\\'"\/\n\r\t\b\f<>]/,
__fest_jshash={'"':'\\"',"\\":"\\\\","/":"\\/","\n":"\\n","\r":"\\r","\t":"\\t","\b":"\\b","\f":"\\f","'":"\\'","<":"\\u003C",">":"\\u003E"},___fest_log_error;if(typeof __fest_error==="undefined")___fest_log_error=typeof console!=="undefined"&&console.error?function(){return Function.prototype.apply.call(console.error,console,arguments)}:function(){};else ___fest_log_error=__fest_error;function __fest_log_error(msg){___fest_log_error(msg+'\nin block "'+__fest_debug_block+'" at line: '+__fest_debug_line+
"\nfile: "+__fest_debug_file)}function __fest_replaceHTML(chr){return __fest_htmlhash[chr]}function __fest_replaceJS(chr){return __fest_jshash[chr]}function __fest_extend(dest,src){for(var i in src)if(src.hasOwnProperty(i))dest[i]=src[i]}function __fest_param(fn){fn.param=true;return fn}function __fest_call(fn,params,cp){if(cp)for(var i in params)if(typeof params[i]=="function"&&params[i].param)params[i]=params[i]();return fn.call(__fest_self,params)}function __fest_escapeJS(s){if(typeof s==="string"){if(__fest_jschars_test.test(s))return s.replace(__fest_jschars,
__fest_replaceJS)}else if(typeof s==="undefined")return"";return s}function __fest_escapeHTML(s){if(typeof s==="string"){if(__fest_htmlchars_test.test(s))return s.replace(__fest_htmlchars,__fest_replaceHTML)}else if(typeof s==="undefined")return"";return s}var json=__fest_context;(function(__fest_context){__fest_blocks.attaches__image=function(params){var __fest_buf=[];__fest_buf.push('<div class="attachviewer__toolbar attachviewer__toolbar_top">');try{__fest_attrs[0]=__fest_escapeHTML(params.mail.Id)}catch(e){__fest_attrs[0]=
"";__fest_log_error(e.message)}__fest_buf.push('<a class="attachviewer__toolbar__subject js-subject" href="/message/'+__fest_attrs[0]+'/" target="_blank"><span class="attachviewer__toolbar__subject__link">');try{__fest_buf.push(__fest_escapeHTML(params.mail.FromShort))}catch(e){__fest_log_error(e.message+"6")}__fest_buf.push('</span><span class="attachviewer__toolbar__subject__text">&nbsp;&nbsp;&nbsp;&nbsp;');try{__fest_buf.push(__fest_escapeHTML(params.mail.Subject))}catch(e){__fest_log_error(e.message+
"10")}__fest_buf.push('</span></a></div><div class="attachviewer__inner__scroll"><div class="attachviewer__viewer attachviewer__viewer_image js-image-viewer">');try{__fest_if=params.file.imageUrl}catch(e){__fest_if=false;__fest_log_error(e.message)}if(__fest_if){__fest_buf.push('<div class="w-attachviewer__viewer__image">');try{__fest_attrs[0]=__fest_escapeHTML(params.file.imageUrl)}catch(e){__fest_attrs[0]="";__fest_log_error(e.message)}__fest_buf.push('<img src="'+__fest_attrs[0]+'" class="attachviewer__viewer__image"/></div>')}__fest_buf.push("</div></div>");
return __fest_buf.join("")}})(__fest_context);__fest_select="attaches__image";__fest_params={};try{__fest_params=json}catch(e){__fest_log_error(e.message)}__fest_chunks.push(__fest_buf.join(""),{name:__fest_select,params:__fest_params,cp:false});__fest_buf=[];__fest_to=__fest_chunks.length;if(__fest_to){__fest_iterator=0;for(;__fest_iterator<__fest_to;__fest_iterator++){__fest_chunk=__fest_chunks[__fest_iterator];if(typeof __fest_chunk==="string")__fest_html.push(__fest_chunk);else{__fest_fn=__fest_blocks[__fest_chunk.name];
if(__fest_fn)__fest_html.push(__fest_call(__fest_fn,__fest_chunk.params,__fest_chunk.cp))}}__fest_html.push(__fest_buf.join(""));return __fest_html.join("")}else return __fest_buf.join("")};if(x.jsLoader!==undefined&&x.jsLoader.loaded!==undefined&&typeof x.jsLoader.loaded==="function")x.jsLoader.loaded("{festTemplate}pages/attachviewer/attachviewer__image")})();(function(){var x=Function("return this")();if(!x.fest)x.fest={};x.fest["pages/attachviewer/attachviewer__MSDoc"]=function(__fest_context){var __fest_self=
this,__fest_buf=[],__fest_chunks=[],__fest_chunk,__fest_attrs=[],__fest_select,__fest_if,__fest_iterator,__fest_to,__fest_fn,__fest_html=[],__fest_blocks={},__fest_params,__fest_element,__fest_debug_file="",__fest_debug_line="",__fest_debug_block="",__fest_htmlchars=/[&<>"]/g,__fest_htmlchars_test=/[&<>"]/,__fest_short_tags={"area":true,"base":true,"br":true,"col":true,"command":true,"embed":true,"hr":true,"img":true,"input":true,"keygen":true,"link":true,"meta":true,"param":true,"source":true,"wbr":true},
__fest_element_stack=[],__fest_htmlhash={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"},__fest_jschars=/[\\'"\/\n\r\t\b\f<>]/g,__fest_jschars_test=/[\\'"\/\n\r\t\b\f<>]/,__fest_jshash={'"':'\\"',"\\":"\\\\","/":"\\/","\n":"\\n","\r":"\\r","\t":"\\t","\b":"\\b","\f":"\\f","'":"\\'","<":"\\u003C",">":"\\u003E"},___fest_log_error;if(typeof __fest_error==="undefined")___fest_log_error=typeof console!=="undefined"&&console.error?function(){return Function.prototype.apply.call(console.error,console,arguments)}:
function(){};else ___fest_log_error=__fest_error;function __fest_log_error(msg){___fest_log_error(msg+'\nin block "'+__fest_debug_block+'" at line: '+__fest_debug_line+"\nfile: "+__fest_debug_file)}function __fest_replaceHTML(chr){return __fest_htmlhash[chr]}function __fest_replaceJS(chr){return __fest_jshash[chr]}function __fest_extend(dest,src){for(var i in src)if(src.hasOwnProperty(i))dest[i]=src[i]}function __fest_param(fn){fn.param=true;return fn}function __fest_call(fn,params,cp){if(cp)for(var i in params)if(typeof params[i]==
"function"&&params[i].param)params[i]=params[i]();return fn.call(__fest_self,params)}function __fest_escapeJS(s){if(typeof s==="string"){if(__fest_jschars_test.test(s))return s.replace(__fest_jschars,__fest_replaceJS)}else if(typeof s==="undefined")return"";return s}function __fest_escapeHTML(s){if(typeof s==="string"){if(__fest_htmlchars_test.test(s))return s.replace(__fest_htmlchars,__fest_replaceHTML)}else if(typeof s==="undefined")return"";return s}var json=__fest_context;(function(__fest_context){__fest_blocks.attaches__MSDoc=
function(params){var __fest_buf=[];__fest_buf.push('<div class="attachviewer__toolbar attachviewer__toolbar_top">');try{__fest_attrs[0]=__fest_escapeHTML(params.mail.Id)}catch(e){__fest_attrs[0]="";__fest_log_error(e.message)}__fest_buf.push('<a class="attachviewer__toolbar__subject js-subject" href="/message/'+__fest_attrs[0]+'/" target="_blank"><span class="attachviewer__toolbar__subject__link">');try{__fest_buf.push(__fest_escapeHTML(params.mail.FromShort))}catch(e){__fest_log_error(e.message+
"6")}__fest_buf.push('</span><span class="attachviewer__toolbar__subject__text">&nbsp;&nbsp;&nbsp;&nbsp;');try{__fest_buf.push(__fest_escapeHTML(params.mail.Subject))}catch(e){__fest_log_error(e.message+"10")}__fest_buf.push('</span></a></div><div class="attachviewer__viewer attachviewer__viewer_msdoc"><div class="attachviewer__viewer__wrap">');try{__fest_attrs[0]=__fest_escapeHTML(params.mode==="msv"?params.previewMSVUrl:params.previewMRVUrl)}catch(e){__fest_attrs[0]="";__fest_log_error(e.message)}__fest_buf.push('<iframe class="js-msdocIframe" src="'+
__fest_attrs[0]+'" frameborder="0" style="width: 100%; height: 100%; position: relative;"></iframe></div></div>');return __fest_buf.join("")}})(__fest_context);__fest_select="attaches__MSDoc";__fest_params={};try{__fest_params=json}catch(e){__fest_log_error(e.message)}__fest_chunks.push(__fest_buf.join(""),{name:__fest_select,params:__fest_params,cp:false});__fest_buf=[];__fest_to=__fest_chunks.length;if(__fest_to){__fest_iterator=0;for(;__fest_iterator<__fest_to;__fest_iterator++){__fest_chunk=__fest_chunks[__fest_iterator];
if(typeof __fest_chunk==="string")__fest_html.push(__fest_chunk);else{__fest_fn=__fest_blocks[__fest_chunk.name];if(__fest_fn)__fest_html.push(__fest_call(__fest_fn,__fest_chunk.params,__fest_chunk.cp))}}__fest_html.push(__fest_buf.join(""));return __fest_html.join("")}else return __fest_buf.join("")};if(x.jsLoader!==undefined&&x.jsLoader.loaded!==undefined&&typeof x.jsLoader.loaded==="function")x.jsLoader.loaded("{festTemplate}pages/attachviewer/attachviewer__MSDoc")})();(function(){var x=Function("return this")();
if(!x.fest)x.fest={};x.fest["pages/attachviewer/attachviewer__other"]=function(__fest_context){var __fest_self=this,__fest_buf=[],__fest_chunks=[],__fest_chunk,__fest_attrs=[],__fest_select,__fest_if,__fest_iterator,__fest_to,__fest_fn,__fest_html=[],__fest_blocks={},__fest_params,__fest_element,__fest_debug_file="",__fest_debug_line="",__fest_debug_block="",__fest_htmlchars=/[&<>"]/g,__fest_htmlchars_test=/[&<>"]/,__fest_short_tags={"area":true,"base":true,"br":true,"col":true,"command":true,"embed":true,
"hr":true,"img":true,"input":true,"keygen":true,"link":true,"meta":true,"param":true,"source":true,"wbr":true},__fest_element_stack=[],__fest_htmlhash={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"},__fest_jschars=/[\\'"\/\n\r\t\b\f<>]/g,__fest_jschars_test=/[\\'"\/\n\r\t\b\f<>]/,__fest_jshash={'"':'\\"',"\\":"\\\\","/":"\\/","\n":"\\n","\r":"\\r","\t":"\\t","\b":"\\b","\f":"\\f","'":"\\'","<":"\\u003C",">":"\\u003E"},___fest_log_error;if(typeof __fest_error==="undefined")___fest_log_error=typeof console!==
"undefined"&&console.error?function(){return Function.prototype.apply.call(console.error,console,arguments)}:function(){};else ___fest_log_error=__fest_error;function __fest_log_error(msg){___fest_log_error(msg+'\nin block "'+__fest_debug_block+'" at line: '+__fest_debug_line+"\nfile: "+__fest_debug_file)}function __fest_replaceHTML(chr){return __fest_htmlhash[chr]}function __fest_replaceJS(chr){return __fest_jshash[chr]}function __fest_extend(dest,src){for(var i in src)if(src.hasOwnProperty(i))dest[i]=
src[i]}function __fest_param(fn){fn.param=true;return fn}function __fest_call(fn,params,cp){if(cp)for(var i in params)if(typeof params[i]=="function"&&params[i].param)params[i]=params[i]();return fn.call(__fest_self,params)}function __fest_escapeJS(s){if(typeof s==="string"){if(__fest_jschars_test.test(s))return s.replace(__fest_jschars,__fest_replaceJS)}else if(typeof s==="undefined")return"";return s}function __fest_escapeHTML(s){if(typeof s==="string"){if(__fest_htmlchars_test.test(s))return s.replace(__fest_htmlchars,
__fest_replaceHTML)}else if(typeof s==="undefined")return"";return s}var json=__fest_context;(function(__fest_context){(function(__fest_context){__fest_blocks.player=function(params){var __fest_buf=[];__fest_buf.push('<div class="player js-player"><a class="player__icon icon_player icon_player_play js-play" onclick="return false;"></a> <div class="player__playback js-playback"><span class="js-time">00:00</span> <div class="player__trackbar js-trackbar"><div class="player__trackbar__buffer js-trackbar-progress" style="width:0"></div><div class="player__trackbar__default"></div><div class="player__trackbar__progress js-trackbar-position" style="width:0"></div><div class="player__trackbar__handle js-handle" style="left:-5px; display:none;"><div class="player__trackbar__handle_inner"></div></div><div class="player__tooltip js-tooltip" style="display:none;"></div></div></div> <div class="player__volume js-volume"><a class="player__icon_volume icon_player icon_player_volume js-mute"></a> <div class="player__trackbar player__trackbar_volume js-volumebar"><div class="player__trackbar__default"></div><div class="player__trackbar__inactive js-volume-level" style="width:0"></div><div class="player__trackbar__active js-volume-level js-volume-active" style="width:0; display:none"></div></div></div></div>');
return __fest_buf.join("")}})(__fest_context);__fest_blocks.attaches__other=function(params){var __fest_buf=[];__fest_buf.push('<div class="attachviewer__toolbar attachviewer__toolbar_top">');try{__fest_attrs[0]=__fest_escapeHTML(params.mail.Id)}catch(e){__fest_attrs[0]="";__fest_log_error(e.message)}__fest_buf.push('<a class="attachviewer__toolbar__subject js-subject" href="/message/'+__fest_attrs[0]+'/" target="_blank"><span class="attachviewer__toolbar__subject__link">');try{__fest_buf.push(__fest_escapeHTML(params.mail.FromShort))}catch(e){__fest_log_error(e.message+
"7")}__fest_buf.push('</span><span class="attachviewer__toolbar__subject__text">&nbsp;&nbsp;&nbsp;&nbsp;');try{__fest_buf.push(__fest_escapeHTML(params.mail.Subject))}catch(e){__fest_log_error(e.message+"11")}__fest_buf.push('</span></a></div><div class="attachviewer__viewer attachviewer__viewer_other');try{__fest_if=patron.AudioPlayerApi&&params.file.IsMp3}catch(e){__fest_if=false;__fest_log_error(e.message)}if(__fest_if)__fest_buf.push(" attachviewer__viewer_audio");__fest_buf.push('">');try{__fest_attrs[0]=
__fest_escapeHTML(params.file.iconType)}catch(e){__fest_attrs[0]="";__fest_log_error(e.message)}__fest_buf.push('<div class="attachviewer__viewer__icon attachviewer__viewer__icon_'+__fest_attrs[0]+' js-event-attachViewerPreviewDownloadClick.attachViewer js-downloadLink"></div><div class="attachviewer__viewer__info js-info"><div class="attachviewer__viewer__name">');try{__fest_buf.push(__fest_escapeHTML(params.file.name))}catch(e){__fest_log_error(e.message+"39")}__fest_buf.push("</div>");try{__fest_if=
patron.AudioPlayerApi&&params.file.IsMp3}catch(e){__fest_if=false;__fest_log_error(e.message)}if(__fest_if){__fest_select="player";__fest_params={};__fest_fn=__fest_blocks[__fest_select];if(__fest_fn)__fest_buf.push(__fest_call(__fest_fn,__fest_params,false))}__fest_buf.push('<div class="attachviewer__viewer__size">');try{__fest_buf.push(__fest_escapeHTML(String.sizeFormat(params.file.size)))}catch(e){__fest_log_error(e.message+"47")}__fest_buf.push("</div>");try{__fest_if=params.file.messageReadUrl}catch(e){__fest_if=
false;__fest_log_error(e.message)}if(__fest_if){__fest_buf.push("<div>");try{__fest_attrs[0]=__fest_escapeHTML(params.file.messageReadUrl)}catch(e){__fest_attrs[0]="";__fest_log_error(e.message)}__fest_buf.push('<a href="'+__fest_attrs[0]+'" target="_blank" class="attachviewer__toolbar__link js-event-attachViewerPreviewDownloadClick.attachViewer js-downloadLink"><i class="icon icon_attachview icon_attachview_download"></i>&nbsp;<span class="attachviewer__toolbar__text">');try{__fest_buf.push(__fest_escapeHTML(json.lang.blocks.attaches.other.read))}catch(e){__fest_log_error(e.message+
"59")}__fest_buf.push("</span></a>");try{__fest_if=patron.EnableAttachToCloud&&!params.file.disableAttachToCloud}catch(e){__fest_if=false;__fest_log_error(e.message)}if(__fest_if){__fest_buf.push('<div style="margin-top: 5px;">');try{__fest_attrs[0]=__fest_escapeHTML(params.file.PartID)}catch(e){__fest_attrs[0]="";__fest_log_error(e.message)}try{__fest_attrs[1]=__fest_escapeHTML(params.file.name)}catch(e){__fest_attrs[1]="";__fest_log_error(e.message)}__fest_buf.push('<a href="#" data-id="'+__fest_attrs[0]+
'" data-filename="'+__fest_attrs[1]+'" class="js-attachToCloud attachviewer__toolbar__link"><span class="attachviewer__toolbar__text">');try{__fest_buf.push(__fest_escapeHTML(json.lang.blocks.attaches.other.to_cloud))}catch(e){__fest_log_error(e.message+"66")}__fest_buf.push('</span><i class="icon icon_attach-to-cloud"></i></a></div>')}__fest_buf.push("</div>")}else{try{__fest_if=params.file.downloadUrl}catch(e){__fest_if=false;__fest_log_error(e.message)}if(__fest_if){__fest_buf.push("<div>");try{__fest_attrs[0]=
__fest_escapeHTML(params.file.downloadUrl)}catch(e){__fest_attrs[0]="";__fest_log_error(e.message)}__fest_buf.push('<a href="'+__fest_attrs[0]+'" class="attachviewer__toolbar__link js-event-attachViewerPreviewDownloadClick.attachViewer js-downloadLink">');try{__fest_if=patron.NewAttachViewerPopup}catch(e){__fest_if=false;__fest_log_error(e.message)}if(__fest_if){__fest_buf.push('<span class="attachviewer__toolbar__text">');try{__fest_buf.push(__fest_escapeHTML(json.lang.blocks.attaches.other.download))}catch(e){__fest_log_error(e.message+
"81")}__fest_buf.push('</span><i class="icon icon_folders icon_filedownload"></i>')}else{__fest_buf.push('<i class="icon icon_attachview icon_attachview_download"></i>&nbsp;<span class="attachviewer__toolbar__text">');try{__fest_buf.push(__fest_escapeHTML(json.lang.blocks.attaches.other.download))}catch(e){__fest_log_error(e.message+"93")}__fest_buf.push("</span>")}__fest_buf.push("</a>");try{__fest_if=patron.EnableAttachToCloud&&!params.file.disableAttachToCloud}catch(e){__fest_if=false;__fest_log_error(e.message)}if(__fest_if){__fest_buf.push('<div style="margin-top: 5px;">');
try{__fest_attrs[0]=__fest_escapeHTML(params.file.PartID)}catch(e){__fest_attrs[0]="";__fest_log_error(e.message)}try{__fest_attrs[1]=__fest_escapeHTML(params.file.name)}catch(e){__fest_attrs[1]="";__fest_log_error(e.message)}__fest_buf.push('<a href="#" data-id="'+__fest_attrs[0]+'" data-filename="'+__fest_attrs[1]+'" class="js-attachToCloud attachviewer__toolbar__link"><span class="attachviewer__toolbar__text">');try{__fest_buf.push(__fest_escapeHTML(json.lang.blocks.attaches.other.to_cloud))}catch(e){__fest_log_error(e.message+
"102")}__fest_buf.push('</span><i class="icon icon_attach-to-cloud"></i></a></div>')}__fest_buf.push("</div>")}else;}__fest_buf.push("</div></div>");return __fest_buf.join("")}})(__fest_context);__fest_select="attaches__other";__fest_params={};try{__fest_params=json}catch(e){__fest_log_error(e.message)}__fest_chunks.push(__fest_buf.join(""),{name:__fest_select,params:__fest_params,cp:false});__fest_buf=[];__fest_to=__fest_chunks.length;if(__fest_to){__fest_iterator=0;for(;__fest_iterator<__fest_to;__fest_iterator++){__fest_chunk=
__fest_chunks[__fest_iterator];if(typeof __fest_chunk==="string")__fest_html.push(__fest_chunk);else{__fest_fn=__fest_blocks[__fest_chunk.name];if(__fest_fn)__fest_html.push(__fest_call(__fest_fn,__fest_chunk.params,__fest_chunk.cp))}}__fest_html.push(__fest_buf.join(""));return __fest_html.join("")}else return __fest_buf.join("")};if(x.jsLoader!==undefined&&x.jsLoader.loaded!==undefined&&typeof x.jsLoader.loaded==="function")x.jsLoader.loaded("{festTemplate}pages/attachviewer/attachviewer__other")})();
(function(){var x=Function("return this")();if(!x.fest)x.fest={};x.fest["pages/attachviewer/attachviewer__pdf"]=function(__fest_context){var __fest_self=this,__fest_buf=[],__fest_chunks=[],__fest_chunk,__fest_attrs=[],__fest_select,__fest_if,__fest_iterator,__fest_to,__fest_fn,__fest_html=[],__fest_blocks={},__fest_params,__fest_element,__fest_debug_file="",__fest_debug_line="",__fest_debug_block="",__fest_htmlchars=/[&<>"]/g,__fest_htmlchars_test=/[&<>"]/,__fest_short_tags={"area":true,"base":true,
"br":true,"col":true,"command":true,"embed":true,"hr":true,"img":true,"input":true,"keygen":true,"link":true,"meta":true,"param":true,"source":true,"wbr":true},__fest_element_stack=[],__fest_htmlhash={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"},__fest_jschars=/[\\'"\/\n\r\t\b\f<>]/g,__fest_jschars_test=/[\\'"\/\n\r\t\b\f<>]/,__fest_jshash={'"':'\\"',"\\":"\\\\","/":"\\/","\n":"\\n","\r":"\\r","\t":"\\t","\b":"\\b","\f":"\\f","'":"\\'","<":"\\u003C",">":"\\u003E"},___fest_log_error;if(typeof __fest_error===
"undefined")___fest_log_error=typeof console!=="undefined"&&console.error?function(){return Function.prototype.apply.call(console.error,console,arguments)}:function(){};else ___fest_log_error=__fest_error;function __fest_log_error(msg){___fest_log_error(msg+'\nin block "'+__fest_debug_block+'" at line: '+__fest_debug_line+"\nfile: "+__fest_debug_file)}function __fest_replaceHTML(chr){return __fest_htmlhash[chr]}function __fest_replaceJS(chr){return __fest_jshash[chr]}function __fest_extend(dest,src){for(var i in src)if(src.hasOwnProperty(i))dest[i]=
src[i]}function __fest_param(fn){fn.param=true;return fn}function __fest_call(fn,params,cp){if(cp)for(var i in params)if(typeof params[i]=="function"&&params[i].param)params[i]=params[i]();return fn.call(__fest_self,params)}function __fest_escapeJS(s){if(typeof s==="string"){if(__fest_jschars_test.test(s))return s.replace(__fest_jschars,__fest_replaceJS)}else if(typeof s==="undefined")return"";return s}function __fest_escapeHTML(s){if(typeof s==="string"){if(__fest_htmlchars_test.test(s))return s.replace(__fest_htmlchars,
__fest_replaceHTML)}else if(typeof s==="undefined")return"";return s}var json=__fest_context;(function(__fest_context){__fest_blocks.attaches__pdf=function(params){var __fest_buf=[];__fest_buf.push('<div class="attachviewer__toolbar attachviewer__toolbar_top">');try{__fest_attrs[0]=__fest_escapeHTML(params.mail.Id)}catch(e){__fest_attrs[0]="";__fest_log_error(e.message)}__fest_buf.push('<a class="attachviewer__toolbar__subject js-subject" href="/message/'+__fest_attrs[0]+'/" target="_blank"><span class="attachviewer__toolbar__subject__link">');
try{__fest_buf.push(__fest_escapeHTML(params.mail.FromShort))}catch(e){__fest_log_error(e.message+"6")}__fest_buf.push('</span><span class="attachviewer__toolbar__subject__text">&nbsp;&nbsp;&nbsp;&nbsp;');try{__fest_buf.push(__fest_escapeHTML(params.mail.Subject))}catch(e){__fest_log_error(e.message+"10")}__fest_buf.push('</span></a></div><div class="attachviewer__viewer attachviewer__viewer_pdf"><div class="attachviewer__viewer_pdfwrap">');try{__fest_attrs[0]=__fest_escapeHTML(params.file.notypeInFrameUrl)}catch(e){__fest_attrs[0]=
"";__fest_log_error(e.message)}__fest_buf.push('<iframe class="attachviewer__viewer_textiframe" src="'+__fest_attrs[0]+'" frameborder="0"></iframe></div></div>');return __fest_buf.join("")}})(__fest_context);__fest_select="attaches__pdf";__fest_params={};try{__fest_params=json}catch(e){__fest_log_error(e.message)}__fest_chunks.push(__fest_buf.join(""),{name:__fest_select,params:__fest_params,cp:false});__fest_buf=[];__fest_to=__fest_chunks.length;if(__fest_to){__fest_iterator=0;for(;__fest_iterator<
__fest_to;__fest_iterator++){__fest_chunk=__fest_chunks[__fest_iterator];if(typeof __fest_chunk==="string")__fest_html.push(__fest_chunk);else{__fest_fn=__fest_blocks[__fest_chunk.name];if(__fest_fn)__fest_html.push(__fest_call(__fest_fn,__fest_chunk.params,__fest_chunk.cp))}}__fest_html.push(__fest_buf.join(""));return __fest_html.join("")}else return __fest_buf.join("")};if(x.jsLoader!==undefined&&x.jsLoader.loaded!==undefined&&typeof x.jsLoader.loaded==="function")x.jsLoader.loaded("{festTemplate}pages/attachviewer/attachviewer__pdf")})();
(function(){var x=Function("return this")();if(!x.fest)x.fest={};x.fest["pages/attachviewer/attachviewer__slider"]=function(__fest_context){var __fest_self=this,__fest_buf=[],__fest_chunks=[],__fest_chunk,__fest_attrs=[],__fest_select,__fest_if,__fest_iterator,__fest_to,__fest_fn,__fest_html=[],__fest_blocks={},__fest_params,__fest_element,__fest_debug_file="",__fest_debug_line="",__fest_debug_block="",__fest_htmlchars=/[&<>"]/g,__fest_htmlchars_test=/[&<>"]/,__fest_short_tags={"area":true,"base":true,
"br":true,"col":true,"command":true,"embed":true,"hr":true,"img":true,"input":true,"keygen":true,"link":true,"meta":true,"param":true,"source":true,"wbr":true},__fest_element_stack=[],__fest_htmlhash={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"},__fest_jschars=/[\\'"\/\n\r\t\b\f<>]/g,__fest_jschars_test=/[\\'"\/\n\r\t\b\f<>]/,__fest_jshash={'"':'\\"',"\\":"\\\\","/":"\\/","\n":"\\n","\r":"\\r","\t":"\\t","\b":"\\b","\f":"\\f","'":"\\'","<":"\\u003C",">":"\\u003E"},___fest_log_error;if(typeof __fest_error===
"undefined")___fest_log_error=typeof console!=="undefined"&&console.error?function(){return Function.prototype.apply.call(console.error,console,arguments)}:function(){};else ___fest_log_error=__fest_error;function __fest_log_error(msg){___fest_log_error(msg+'\nin block "'+__fest_debug_block+'" at line: '+__fest_debug_line+"\nfile: "+__fest_debug_file)}function __fest_replaceHTML(chr){return __fest_htmlhash[chr]}function __fest_replaceJS(chr){return __fest_jshash[chr]}function __fest_extend(dest,src){for(var i in src)if(src.hasOwnProperty(i))dest[i]=
src[i]}function __fest_param(fn){fn.param=true;return fn}function __fest_call(fn,params,cp){if(cp)for(var i in params)if(typeof params[i]=="function"&&params[i].param)params[i]=params[i]();return fn.call(__fest_self,params)}function __fest_escapeJS(s){if(typeof s==="string"){if(__fest_jschars_test.test(s))return s.replace(__fest_jschars,__fest_replaceJS)}else if(typeof s==="undefined")return"";return s}function __fest_escapeHTML(s){if(typeof s==="string"){if(__fest_htmlchars_test.test(s))return s.replace(__fest_htmlchars,
__fest_replaceHTML)}else if(typeof s==="undefined")return"";return s}var json=__fest_context;(function(__fest_context){__fest_blocks.attaches__slider=function(params){var __fest_buf=[];__fest_buf.push('<div class="js-sliderPrev attachviewer__slider__nav attachviewer__slider__nav_prev"></div><div class="attachviewer__slider__container"><div class="js-sliderInner w-attachviewer__slider__list"><div class="js-sliderList attachviewer__slider__list"></div></div></div><div class="js-sliderNext attachviewer__slider__nav attachviewer__slider__nav_next"></div>');
return __fest_buf.join("")}})(__fest_context);__fest_select="attaches__slider";__fest_params={};try{__fest_params=json}catch(e){__fest_log_error(e.message)}__fest_chunks.push(__fest_buf.join(""),{name:__fest_select,params:__fest_params,cp:false});__fest_buf=[];__fest_to=__fest_chunks.length;if(__fest_to){__fest_iterator=0;for(;__fest_iterator<__fest_to;__fest_iterator++){__fest_chunk=__fest_chunks[__fest_iterator];if(typeof __fest_chunk==="string")__fest_html.push(__fest_chunk);else{__fest_fn=__fest_blocks[__fest_chunk.name];
if(__fest_fn)__fest_html.push(__fest_call(__fest_fn,__fest_chunk.params,__fest_chunk.cp))}}__fest_html.push(__fest_buf.join(""));return __fest_html.join("")}else return __fest_buf.join("")};if(x.jsLoader!==undefined&&x.jsLoader.loaded!==undefined&&typeof x.jsLoader.loaded==="function")x.jsLoader.loaded("{festTemplate}pages/attachviewer/attachviewer__slider")})();(function(){var x=Function("return this")();if(!x.fest)x.fest={};x.fest["pages/attachviewer/attachviewer__slider__items"]=function(__fest_context){var __fest_self=
this,__fest_buf=[],__fest_chunks=[],__fest_chunk,__fest_attrs=[],__fest_select,__fest_if,__fest_iterator,__fest_to,__fest_fn,__fest_html=[],__fest_blocks={},__fest_params,__fest_element,__fest_debug_file="",__fest_debug_line="",__fest_debug_block="",__fest_htmlchars=/[&<>"]/g,__fest_htmlchars_test=/[&<>"]/,__fest_short_tags={"area":true,"base":true,"br":true,"col":true,"command":true,"embed":true,"hr":true,"img":true,"input":true,"keygen":true,"link":true,"meta":true,"param":true,"source":true,"wbr":true},
__fest_element_stack=[],__fest_htmlhash={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"},__fest_jschars=/[\\'"\/\n\r\t\b\f<>]/g,__fest_jschars_test=/[\\'"\/\n\r\t\b\f<>]/,__fest_jshash={'"':'\\"',"\\":"\\\\","/":"\\/","\n":"\\n","\r":"\\r","\t":"\\t","\b":"\\b","\f":"\\f","'":"\\'","<":"\\u003C",">":"\\u003E"},___fest_log_error;if(typeof __fest_error==="undefined")___fest_log_error=typeof console!=="undefined"&&console.error?function(){return Function.prototype.apply.call(console.error,console,arguments)}:
function(){};else ___fest_log_error=__fest_error;function __fest_log_error(msg){___fest_log_error(msg+'\nin block "'+__fest_debug_block+'" at line: '+__fest_debug_line+"\nfile: "+__fest_debug_file)}function __fest_replaceHTML(chr){return __fest_htmlhash[chr]}function __fest_replaceJS(chr){return __fest_jshash[chr]}function __fest_extend(dest,src){for(var i in src)if(src.hasOwnProperty(i))dest[i]=src[i]}function __fest_param(fn){fn.param=true;return fn}function __fest_call(fn,params,cp){if(cp)for(var i in params)if(typeof params[i]==
"function"&&params[i].param)params[i]=params[i]();return fn.call(__fest_self,params)}function __fest_escapeJS(s){if(typeof s==="string"){if(__fest_jschars_test.test(s))return s.replace(__fest_jschars,__fest_replaceJS)}else if(typeof s==="undefined")return"";return s}function __fest_escapeHTML(s){if(typeof s==="string"){if(__fest_htmlchars_test.test(s))return s.replace(__fest_htmlchars,__fest_replaceHTML)}else if(typeof s==="undefined")return"";return s}var json=__fest_context;(function(__fest_context){__fest_blocks.attaches__slider__items=
function(params){var __fest_buf=[];var i,item,__fest_iterator0;try{__fest_iterator0=params.Files||{}}catch(e){__fest_iterator={};__fest_log_error(e.message)}for(i in __fest_iterator0){item=__fest_iterator0[i];try{__fest_if=i>=params.range[0]&&i<params.range[1]}catch(e){__fest_if=false;__fest_log_error(e.message)}if(__fest_if){try{__fest_attrs[0]=__fest_escapeHTML(item.index)}catch(e){__fest_attrs[0]="";__fest_log_error(e.message)}try{__fest_attrs[1]=__fest_escapeHTML(item.isRFC822?ajs.Html.unescape(item.name):
item.name)}catch(e){__fest_attrs[1]="";__fest_log_error(e.message)}try{__fest_attrs[2]=__fest_escapeHTML((i-params.startOffset)*params.itemWidth)}catch(e){__fest_attrs[2]="";__fest_log_error(e.message)}__fest_buf.push('<div class="js-item attachviewer__slider__list__item" data-index="'+__fest_attrs[0]+'" title="'+__fest_attrs[1]+'" style="left: '+__fest_attrs[2]+'px;"><div class="w-attachviewer__slider__list__item"><div style="position: relative;">');try{__fest_attrs[0]=__fest_escapeHTML(item.iconType)}catch(e){__fest_attrs[0]=
"";__fest_log_error(e.message)}__fest_buf.push('<div class="i-spI i-'+__fest_attrs[0]+' attachviewer__slider__list__item__icon"></div><div class="attachviewer__slider__list__item__name">');try{__fest_buf.push(item.isRFC822?item.name:ajs.Html.escape(item.name))}catch(e){__fest_log_error(e.message+"21")}__fest_buf.push("</div>");try{__fest_if=item.previewUrl}catch(e){__fest_if=false;__fest_log_error(e.message)}if(__fest_if){__fest_buf.push('<div class="attachviewer__slider__list__item__preview">');
try{__fest_attrs[0]=__fest_escapeHTML(item.previewUrl)}catch(e){__fest_attrs[0]="";__fest_log_error(e.message)}__fest_buf.push('<img src="'+__fest_attrs[0]+'" onerror="this.parentNode.style.display=\'none\'"/></div>')}__fest_buf.push("</div></div></div>")}}return __fest_buf.join("")}})(__fest_context);__fest_select="attaches__slider__items";__fest_params={};try{__fest_params=json}catch(e){__fest_log_error(e.message)}__fest_chunks.push(__fest_buf.join(""),{name:__fest_select,params:__fest_params,cp:false});
__fest_buf=[];__fest_to=__fest_chunks.length;if(__fest_to){__fest_iterator=0;for(;__fest_iterator<__fest_to;__fest_iterator++){__fest_chunk=__fest_chunks[__fest_iterator];if(typeof __fest_chunk==="string")__fest_html.push(__fest_chunk);else{__fest_fn=__fest_blocks[__fest_chunk.name];if(__fest_fn)__fest_html.push(__fest_call(__fest_fn,__fest_chunk.params,__fest_chunk.cp))}}__fest_html.push(__fest_buf.join(""));return __fest_html.join("")}else return __fest_buf.join("")};if(x.jsLoader!==undefined&&
x.jsLoader.loaded!==undefined&&typeof x.jsLoader.loaded==="function")x.jsLoader.loaded("{festTemplate}pages/attachviewer/attachviewer__slider__items")})();(function(){var x=Function("return this")();if(!x.fest)x.fest={};x.fest["pages/attachviewer/attachviewer__text"]=function(__fest_context){var __fest_self=this,__fest_buf=[],__fest_chunks=[],__fest_chunk,__fest_attrs=[],__fest_select,__fest_if,__fest_iterator,__fest_to,__fest_fn,__fest_html=[],__fest_blocks={},__fest_params,__fest_element,__fest_debug_file=
"",__fest_debug_line="",__fest_debug_block="",__fest_htmlchars=/[&<>"]/g,__fest_htmlchars_test=/[&<>"]/,__fest_short_tags={"area":true,"base":true,"br":true,"col":true,"command":true,"embed":true,"hr":true,"img":true,"input":true,"keygen":true,"link":true,"meta":true,"param":true,"source":true,"wbr":true},__fest_element_stack=[],__fest_htmlhash={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"},__fest_jschars=/[\\'"\/\n\r\t\b\f<>]/g,__fest_jschars_test=/[\\'"\/\n\r\t\b\f<>]/,__fest_jshash={'"':'\\"',
"\\":"\\\\","/":"\\/","\n":"\\n","\r":"\\r","\t":"\\t","\b":"\\b","\f":"\\f","'":"\\'","<":"\\u003C",">":"\\u003E"},___fest_log_error;if(typeof __fest_error==="undefined")___fest_log_error=typeof console!=="undefined"&&console.error?function(){return Function.prototype.apply.call(console.error,console,arguments)}:function(){};else ___fest_log_error=__fest_error;function __fest_log_error(msg){___fest_log_error(msg+'\nin block "'+__fest_debug_block+'" at line: '+__fest_debug_line+"\nfile: "+__fest_debug_file)}
function __fest_replaceHTML(chr){return __fest_htmlhash[chr]}function __fest_replaceJS(chr){return __fest_jshash[chr]}function __fest_extend(dest,src){for(var i in src)if(src.hasOwnProperty(i))dest[i]=src[i]}function __fest_param(fn){fn.param=true;return fn}function __fest_call(fn,params,cp){if(cp)for(var i in params)if(typeof params[i]=="function"&&params[i].param)params[i]=params[i]();return fn.call(__fest_self,params)}function __fest_escapeJS(s){if(typeof s==="string"){if(__fest_jschars_test.test(s))return s.replace(__fest_jschars,
__fest_replaceJS)}else if(typeof s==="undefined")return"";return s}function __fest_escapeHTML(s){if(typeof s==="string"){if(__fest_htmlchars_test.test(s))return s.replace(__fest_htmlchars,__fest_replaceHTML)}else if(typeof s==="undefined")return"";return s}var json=__fest_context;(function(__fest_context){__fest_blocks.attaches__text=function(params){var __fest_buf=[];__fest_buf.push('<div class="attachviewer__toolbar attachviewer__toolbar_top">');try{__fest_attrs[0]=__fest_escapeHTML(params.mail.Id)}catch(e){__fest_attrs[0]=
"";__fest_log_error(e.message)}__fest_buf.push('<a class="attachviewer__toolbar__subject js-subject" href="/message/'+__fest_attrs[0]+'/" target="_blank"><span class="attachviewer__toolbar__subject__link">');try{__fest_buf.push(__fest_escapeHTML(params.mail.FromShort))}catch(e){__fest_log_error(e.message+"6")}__fest_buf.push('</span><span class="attachviewer__toolbar__subject__text">&nbsp;&nbsp;&nbsp;&nbsp;');try{__fest_buf.push(__fest_escapeHTML(params.mail.Subject))}catch(e){__fest_log_error(e.message+
"10")}__fest_buf.push('</span></a></div><div class="attachviewer__viewer attachviewer__viewer_text"><div class="attachviewer__viewer_textwrap">');try{__fest_attrs[0]=__fest_escapeHTML(params.file.notypeInFrameUrl)}catch(e){__fest_attrs[0]="";__fest_log_error(e.message)}__fest_buf.push('<iframe class="attachviewer__viewer_textiframe" src="'+__fest_attrs[0]+'" frameborder="0"></iframe></div></div>');return __fest_buf.join("")}})(__fest_context);__fest_select="attaches__text";__fest_params={};try{__fest_params=
json}catch(e){__fest_log_error(e.message)}__fest_chunks.push(__fest_buf.join(""),{name:__fest_select,params:__fest_params,cp:false});__fest_buf=[];__fest_to=__fest_chunks.length;if(__fest_to){__fest_iterator=0;for(;__fest_iterator<__fest_to;__fest_iterator++){__fest_chunk=__fest_chunks[__fest_iterator];if(typeof __fest_chunk==="string")__fest_html.push(__fest_chunk);else{__fest_fn=__fest_blocks[__fest_chunk.name];if(__fest_fn)__fest_html.push(__fest_call(__fest_fn,__fest_chunk.params,__fest_chunk.cp))}}__fest_html.push(__fest_buf.join(""));
return __fest_html.join("")}else return __fest_buf.join("")};if(x.jsLoader!==undefined&&x.jsLoader.loaded!==undefined&&typeof x.jsLoader.loaded==="function")x.jsLoader.loaded("{festTemplate}pages/attachviewer/attachviewer__text")})();define("{patron.v2}attachment/entry/AbstractEntry",[],function(){function AbstractEntry(attachment,options){options=options||{};this.attachment=attachment;this.name=typeof options.name==="string"?options.name:"";this.parentArchive=options.parentArchive;this.path=options.path;
this.pathHash=options.pathHash||options.path}var p=AbstractEntry.prototype;p.isInArchive=function(){return!!this.parentArchive};p.getKey=function(){if(this.isInArchive())return this.parentArchive.getKey()+"/"+this.pathHash;else return[this.attachment.messageId].concat(this.attachment.partIds).join(";")};p.getPath=function(){return""};return AbstractEntry});define("{patron.v2}attachment/entry/Directory",["{patron.v2}attachment/entry/AbstractEntry"],function(AbstractEntry){function Directory(attachment,
options){options=options||{};AbstractEntry.call(this,attachment,options);this.setContents(options.contents)}var p=Directory.prototype=Object.create(AbstractEntry.prototype);p.constructor=Directory;p.kind="directory";p.setContents=function(entries){this._contents=entries};p.insertEntry=function(entry,position){this._contents.splice(position,0,entry)};p.removeEntry=function(position){this._contents.splice(position,1)};p.getContents=function(){return this._contents};return Directory});define("{patron.v2}attachment/entry/File",
["{patron.v2}attachment/entry/AbstractEntry","{patron.v2}utils/contentTypes"],function(AbstractEntry,contentTypes){function File(attachment,options){options=options||{};AbstractEntry.call(this,attachment,options);this.size=+options.size||0;this.contentType=options.contentType;this.downloadUrl=options.downloadUrl;this.previewUrl=options.previewUrl;this.viewUrl=options.viewUrl}var p=File.prototype=Object.create(AbstractEntry.prototype);p.constructor=File;p.kind="file";p.getIndex=function(){if(this.isInArchive())return this.parentArchive.getIndex().concat(this.parentArchive.getEntryIndex(this.pathHash));
else return this.attachment.partIds};p.getExtension=function(){return~this.name.indexOf(".")?this.name.split(".").pop():""};p.recognizeExtension=function(){var extensions=contentTypes.getExtensions(this.contentType);return extensions&&extensions[0]};p.is=function(category){return contentTypes.is(category,this.contentType)};p.getCategory=function(){return contentTypes.getCategory(this.contentType)};p.requestDirectUrl=function(){};p.getViewUrl=function(){if(this.isInArchive())return patron.ZipviewURL+
"/get/"+this.parentArchive.hash+"/"+this.pathHash;else;};p.getDownloadUrl=function(){if(this.isInArchive())return this.getViewUrl()+"?download=1";else;};p.getViewerUrl=function(){return"/attaches-viewer/?"+ajs.toQuery({id:this.attachment.messageId,offset:this.getIndex().join(";"),"x-email":patron.useremail})};p.getPreviewUrl=function(options){if(this.isInArchive())return patron.ZipviewURL+"/preview/90x90/"+this.parentArchive.hash+"/"+this.pathHash;else;};return File});define("{patron.v2}attachment/entry/Archive",
["{patron.v2}attachment/entry/File","{patron.v2}attachment/entry/Directory","{patron.v2}utils/contentTypes"],function(File,Directory,contentTypes){var requestContentsPromises={},contentsExpirationTime=12E4;var initialGetInfoTime=250;function Archive(attachment,options){options=options||{};File.call(this,attachment,options);this._contents=null;this._pathHashMap={};this._getInfoTime=initialGetInfoTime;this._getInfo=this._getInfo.bind(this);if(options.alreadyProcessed)this._setUp(options.alreadyProcessed)}
var p=Archive.prototype=Object.create(File.prototype);p.constructor=Archive;p.kind="archive";p._invalidate=function(removeFromCache){var key=this.getKey();requestContentsPromises[key].reject();if(removeFromCache)delete requestContentsPromises[key]};p._createEntries=function(files){var that=this,entries=[];Array.forEach(files,function(file){var type=file.type;var entryOptions={name:file.name,parentArchive:that,pathHash:file.path_hash};if(type==="directory")entryOptions.contents=that._createEntries(file.files);
else{var contentType=file.content_type.split(";")[0];if(contentTypes.is("archive",contentType))type="archive";entryOptions.size=file.size;entryOptions.contentType=contentType;entryOptions.downloadUrl=file.content_link;entryOptions.previewUrl=file.preview_link;entryOptions.viewUrl=file.view_link+"?x-email="+patron.useremail;if(file.archive)entryOptions.alreadyProcessed=file.archive}var entry=that.attachment.createEntry(type,entryOptions);that._pathHashMap[entry.pathHash]=entry;entries.push(entry)});
return entries};p._countEntries=function(){var directoiesCount=0,filesCount=0,archivesCount=0,typesCounts={};Array.forEach(this.getEntries(),function(entry){directoiesCount+=entry.kind==="directory";filesCount+=entry.kind==="file";archivesCount+=entry.kind==="archive";if(entry.kind!=="directory"){var extension=entry.getExtension();typesCounts[extension]=(typesCounts[extension]||0)+1}});$.event.trigger("ui-abstract-action",{chain:["archives","directoies",directoiesCount]});$.event.trigger("ui-abstract-action",
{chain:["archives","files",filesCount]});$.event.trigger("ui-abstract-action",{chain:["archives","archives",archivesCount]});Object.forEach(typesCounts,function(value,key){$.event.trigger("ui-abstract-action",{chain:["archives","fileTypes",key,value]})})};p._setUp=function(response){this.hash=response.hash;this._contents=this._createEntries(response.structure.files);this._countEntries();return this._contents};p._getInfo=function(){var that=this,key=this.getKey(),deferred=requestContentsPromises[key];
$.ajax({type:"GET",url:this._infoUrl,xhrFields:{withCredentials:true}}).done(function(response){if(response.status===6){var expirationTime=response.ttl*1E3||contentsExpirationTime;clearTimeout(that._contentCleanupTimeout);that._contentCleanupTimeout=setTimeout(function(){that._getInfoTime=initialGetInfoTime;that._invalidate(true)},expirationTime);clearInterval(that._interval);delete that._interval;deferred.resolve(that._setUp(response));that._interval=setInterval(function(){$.ajax({type:"GET",url:that._infoUrl,
xhrFields:{withCredentials:true}})},expirationTime/2)}else if(response.status<0){clearInterval(that._interval);delete that._interval;that._invalidate(true)}else if(that._getInfoTime<6E4)setTimeout(that._getInfo,that._getInfoTime*=2);else if(!that._interval)that._interval=setInterval(that._getInfo,that._getInfoTime)}).fail(function(){clearInterval(that._interval);delete that._interval;that._invalidate(true)})};p._process=function(url){var that=this;$.ajax({type:"GET",url:url,xhrFields:{withCredentials:true}}).done(function(response){that._secret=
response.secret;that._infoUrl=response.info_link;setTimeout(that._getInfo,that._getInfoTime)}).fail(function(){that._invalidate(true)})};p.requestContents=function(options){options=options||{};var that=this,key=this.getKey(),deferred=requestContentsPromises[key];if(!deferred){deferred=requestContentsPromises[key]=$.Deferred().then(function(){$.event.trigger("ui-abstract-action",{chain:["archives","success"]})},function(){$.event.trigger("ui-abstract-action",{chain:["archives","fail"]})});if(this._contents)deferred.resolve(this._contents);
else if(options.fromCache)this._invalidate(true);else if(this.isInArchive())this._process(patron.ZipviewURL+"/process_nested?"+ajs.toQuery({"hash":this.parentArchive.hash,"path_hash":this.pathHash}));else this.attachment.requestDirectUrl().done(function(directUrl){that._process(patron.ZipviewURL+"/process?"+ajs.toQuery({"url":directUrl,"no_download":+!!options.dontDownload}))}).fail(function(){that._invalidate(true)})}return deferred};p.getContents=Directory.prototype.getContents;p.getEntries=function(){var entries=
[];Object.forEach(this._pathHashMap,function(entry){entries.push(entry)});return entries};p.getEntryIndex=function(pathHash){var entries=this.getEntries(),index=0,entryIndex;Array.forEach(entries,function(entry){if(entry.kind!=="directory"){if(entry.pathHash===pathHash)entryIndex=index;index++}});return entryIndex};p.getEntry=function(pathHash){return this._pathHashMap[pathHash]||null};p.getEntryRecursively=function(pathHashes,getClosestParent){pathHashes=pathHashes instanceof Array?pathHashes:pathHashes?
[pathHashes]:[];if(pathHashes.length){var entry=this.getEntry(pathHashes[0]);if(entry)if(entry.kind==="archive")return entry.getEntryRecursively(pathHashes.slice(1),getClosestParent);else return pathHashes.length===1&&entry||null;else return getClosestParent&&this||null}else return this};p.findEntry=function(pathHashes){var that=this,deferred=$.Deferred();this.requestContents().then(function(contents){pathHashes=pathHashes instanceof Array?pathHashes:pathHashes?[pathHashes]:[];if(pathHashes.length){var entry=
that.getEntry(pathHashes[0]);if(entry.kind==="archive")entry.findEntry(pathHashes.slice(1)).then(function(entry){deferred.resolve(entry)});else deferred.resolve(pathHashes.length===1&&entry||null)}else deferred.resolve(that)});return deferred};return Archive});define("{patron.v2}attachment/Attachment",["{patron.v2}attachment/entry/AbstractEntry","{patron.v2}attachment/entry/Directory","{patron.v2}attachment/entry/File","{patron.v2}attachment/entry/Archive","{patron.v2}utils/contentTypes","{patron}patron.Messages"],
function(AbstractEntry,Directory,File,Archive,contentTypes){var requestDirectUrlPromises={},directUrlExpirationTime=12E4;function Attachment(messageId,partIds){var message=patron.Messages.get(messageId),partId=[messageId].concat(partIds).join(";");if(!message)throw new Error("Message "+messageId+" is not loaded. Use Attachment.getFromMessage() instead or make sure you've preloaded desired message.");var attachmentData=message.getAttachment(partId);if(!attachmentData)throw new Error("Attachment "+
partId+" doesn't exist.");var entryOptions={name:attachmentData.name,contentType:attachmentData.ContentType,size:+attachmentData.OriginalBodyLen||0};this.messageId=messageId;this.partIds=partIds;this.url="/cgi-bin/getattach?id="+encodeURIComponent(partId);if(contentTypes.is("archive",entryOptions.contentType))this.rootEntry=this.createEntry("archive",entryOptions);else this.rootEntry=this.createEntry("file",entryOptions)}Attachment.getFromMessage=function(messageId,partIds){var deferred=new $.Deferred;
patron.Messages.find({id:messageId}).then(function(message){deferred.resolve(new Attachment(messageId,partIds))});return deferred};var p=Attachment.prototype;p.requestDirectUrl=function(){var that=this,deferred=requestDirectUrlPromises[this.url];if(!deferred){deferred=requestDirectUrlPromises[this.url]=new $.Deferred;$.ajax({type:"GET",url:this.url}).done(function(response){if(response[1]==="Redirect"){clearTimeout(that._directUrlTimeout);that._directUrlTimeout=setTimeout(function(){requestDirectUrlPromises[that.url].reject();
delete requestDirectUrlPromises[that.url]},directUrlExpirationTime);deferred.resolve(response[2])}else{deferred.reject();delete requestDirectUrlPromises[that.url]}}).fail(function(){deferred.reject();delete requestDirectUrlPromises[that.url]})}return deferred};p.createEntry=function(type,options){switch(type){case "directory":return new Directory(this,options);case "file":return new File(this,options);case "archive":return new Archive(this,options)}};return Attachment});jsLoader.use(["{patron.v2}utils/docs",
"{patron.v2}utils/apf","{jQuery}jquery"],function(docs,apf){jsClass.create("patron.FullAttachViewer.Utils").statics({createFilesTree:function(viewerData,response){var utils=this;var PartID=response[2][0];var tree={leafs:{},root:function(){return this.get("root")},get:function(id){return this.leafs[id]},push:function(file){this.leafs[file.id]=file;file.tree=this;if(file.parent&&this.leafs[file.parent])this.leafs[file.parent].children.push(file.id)},getVisibleNodesCount:function(id){var t=this,node=
t.get(id),result=1;if(node.isFolder&&node.isOpen&&node.children&&node.children.length)Array.forEach(node.children,function(child){result+=t.getVisibleNodesCount(child)});return result}};function createNode(data){var folder={id:null,parent:null,children:[],tree:tree,isOpen:false,list:function(){var result=[];Array.forEach(this.children,function(id){result.push(this.tree.get(id))}.bind(this));result.sort(function(a,b){return a.name.toLowerCase()<b.name.toLowerCase()?-1:a.name.toLowerCase()>b.name.toLowerCase()?
1:0});return result},toggleOpen:function(){this.isOpen=!this.isOpen},isVisible:function(){return this.parent=="root"||this.tree.get(this.parent).isVisible()&&this.tree.get(this.parent).isOpen}};return $.extend(folder,data)}function convertAttzipResponse(response,parent){for(var name in response){var file={};file.id=name;file.parent=parent;if(parent)file.id=parent+"/"+file.id;if(response[name]instanceof Array){file=$.extend(file,utils.createFileDescription(viewerData,{name:name,size:response[name][0],
encrypted:response[name][1],path:response[name][2],PartID:PartID},tree.length),response[name][4]||{});file=createNode(file);tree.push(file)}else{file=$.extend(file,{name:name.substring(0,name.length-1),type:"folder",ext:"f",isFolder:1});file=createNode(file);tree.push(file);convertAttzipResponse(response[name],file.id)}}}var root=createNode({id:"root",parent:null});tree.push(root);convertAttzipResponse(response[2][1],root.id);return tree},createLinkDescription:function(viewerData,fileData,index){var file=
$.extend({ContentType:"",avstatus:"",name:"",size:0,downloadlink:"",duedate:"",ext:""},fileData);if(typeof file.name=="string")file.ext=file.name.replace(/(.*)\./,"").toLowerCase();file.iconType=this.getFileIconType(file);return file},preloadImages:function(src){if(typeof src==="string")src=src.split(",");else if(!$.isArray(src))return-1;var namespace="#preloadIMG"+$.expando;if(!$(namespace)[0])$("<div />",{id:namespace.slice(1)}).hide().appendTo("body");$.each(src,function(){$("<img />",{src:this}).appendTo(namespace)})},
createFileDescription:function(viewerData,fileData,index){if(fileData.ContentName)try{fileData.ContentName=decodeURIComponent(fileData.ContentName);fileData.ContentEncoding=decodeURIComponent(fileData.ContentEncoding)}catch(e){}var file=$.extend({Subject:"",name:"",size:0,PartID:"",Channel:"",tnef_id:"",ContentText:"",ContentType:"",isRFC822:0,DontShow:0,ForceAddNotype:0,ShowThumbnail:0,AddPhoto:0,IsImage:0,isTNEF:0,IsRtf:0,IsMp3:0,ext:"",BodyStart:"",OriginalBodyLen:"",ContentName:"",ContentEncoding:"",
encrypted:0,isFolder:0},fileData);if(file.isRFC822){if(file.Subject)file.name=file.Subject;else file.name=Lang.get("message.email.untitled");file.ext="eml"}else{if(file.FileName)file.name=file.FileName;file.name=""+file.name;file.ext=file.name.replace(/^.*?(?:\.([^.]+))?$/,"$1").toLowerCase()}file.iconType=this.getFileIconType(file);file.attachPreviewUrl=this.getAttachPreviewUrl(viewerData,file,index);file.downloadUrl=file.downloadUrl||this.getFileDownloadUrl(viewerData,file,true);file.downloadFromZipUrl=
file.downloadFromZipUrl||this.getFileDownloadFromZipUrl(viewerData,file);file.previewWithCropUrl=file.previewWithCropUrl||this.getImagePreviewUrl(viewerData,file,0,160,120);file.previewUrl=file.previewUrl||this.getImagePreviewUrl(viewerData,file,90);file.previewMSVUrl=file.previewMSVUrl||this.getMSVUrl(viewerData,file);file.defaultPreviewUrl=file.defaultPreviewUrl||this.getImagePreviewUrl(viewerData,file);file.messageReadUrl=file.messageReadUrl||this.getMessageReadUrl(viewerData,file);file.imageUrl=
file.imageUrl||this.getImageUrl(viewerData,file);file.addPhotoUrl=file.addPhotoUrl||this.getFileAddPhotoUrl(viewerData,file);file.notypeInFrameUrl=file.notypeInFrameUrl||this.getFileDownloadUrl(viewerData,file,false,true);file.mp3Url=file.mp3Url||this.getMp3Url(viewerData,file);file.type=this.getFileType(file);file.humanSize=this.getFileHumanSize(file);file.index=index;if(this.isGraphicPreview(file))file.ShowThumbnail=1;return file},isFileFromCloud:function(file){return file.__type==="cloud"},isFileFromFilesearch:function(file){return file.__type===
"filesearch"},getFileHumanSize:function(file){function round(value,precision){return value.toFixed(precision).toString().replace(/0+$/,"").replace(/\.$/,"")}if(file.size<1024)return{size:file.size,unit:"B"};else if(file.size<1048576)return{size:round(file.size/1024,0),unit:"kB"};else if(file.size<1073741824)return{size:round(file.size/1048576,2),unit:"MB"};else if(file.size<1099511627776)return{size:round(file.size/1073741824,2),unit:"GB"};else if(file.size<0x3fffffffffffc)return{size:round(file.size/
1099511627776,2),unit:"TB"};else if(file.size<1,1.4841790497948E30)return{size:round(file.size/0x3fffffffffffc,2),unit:"PB"}},getAttachPreviewUrl:function(data,file,index){return"/attaches-viewer/?"+$.param({"x-email":patron.useremail,offset:index,id:data.Id,_av:file.isTNEF?index:file.PartID})},getAttachIndex:function(attach,messageId){var PartID=attach.PartID||"",MessageID=attach.MessageID||messageId;return PartID.replace(MessageID+";","")+(attach.isTNEF?";"+attach.tnef_id:"")},getFileDownloadFromZipUrl:function(data,
file){return"/cgi-bin/getattach?mode=attachment-zip&id="+file.PartID+"&file="+encodeURIComponent(file.path)},getFileDownloadUrl:function(data,file,notype,frame){var result="";var params={id:file.PartID,"x-email":patron.useremail,bs:file.BodyStart,bl:file.OriginalBodyLen,ct:file.ContentType,cn:file.ContentName,cte:file.ContentEncoding};if(notype)$.extend(params,{notype:1});if(frame)$.extend(params,{frame:1});if(file.isTNEF&&!file.IsRtf)result="/cgi-bin/get_tnef_part?"+ajs.toQuery($.extend(params,{tnef_id:file.tnef_id,
mode:"tnef_attach"}));else{var baseUrl="/cgi-bin/getattach?";if(!frame)baseUrl=location.protocol+"//"+data.MainMailHost+baseUrl;result=baseUrl+ajs.toQuery($.extend(params,{file:file.name,mode:"attachment",channel:file.Channel,"x-email":patron.useremail}))}return result},getFileAddPhotoUrl:function(data,file){var result="";if(file.AddPhoto)result="//foto.mail.ru/cgi-bin/photo/addphoto?"+ajs.toQuery({frommail:file.PartID,mode:"0"});return result},getMessageReadUrl:function(data,file){var result="";
if(file.isRFC822&&!file.DontShow){result=patron.getPageURL("readmsg",{id:file.PartID});if(file.ForceAddNotype)result+="?notype=1"}return result},isGraphicPreview:function(file){return patron["IsMRVGraphicPreviewEnabled"]&&(file.ext=="psd"||file.ext=="tga"||file.ext=="ai"||file.ext=="tif"||file.ext=="tiff"||file.ext=="eps")},isOfficePreview:function(file){return(patron["IsCorpUser"]||patron["IsMRVOfficePreviewOnlyReadmsg"]&&patron["isReadMsg"])&&(patron["IsMRVMSDocPreviewEnabled"]||patron["IsMRVMSPptPreviewEnabled"]||
patron["IsMRVMSExcelPreviewEnabled"])&&(file.ext=="doc"||file.ext=="docx"||file.ext=="xls"||file.ext=="xlsx"||file.ext=="ppt"||file.ext=="pptx"||file.ext=="pdf")},isCSVPreview:function(file){return patron["IsMRVCsvPreviewEnabled"]&&file.ext=="csv"},getImageUrl:function(data,file){var result="";var params={id:file.PartID,"x-email":patron.useremail};if(file.isTNEF&&!file.IsRtf)result="/cgi-bin/get_tnef_part?"+ajs.toQuery($.extend({},params,{tnef_id:file.tnef_id,mode:"tnef_attach"}));else if(this.isGraphicPreview(file))result=
"//docs."+(patron.SingleDomainName||"mail.ru")+"/preview/?"+ajs.toQuery({src:file.downloadUrl});else if(file.ShowThumbnail&&(file.IsImage||file.AddPhoto)){result="//"+data.MainMailHost+"/cgi-bin/getattach?"+ajs.toQuery($.extend({},params,{file:file.name,mode:"attachment",channel:file.Channel}));if(patron.exif){$.extend(params,{exif:1,bs:file.BodyStart,bl:file.OriginalBodyLen,ct:file.ContentType,cn:file.ContentName,cte:file.ContentEncoding});result=(patron.IsWinDev||patron.IsDevMyCom?"http://":"//")+
(patron.MailAttachPreviewHost||"apf."+(patron.SingleDomainName||"mail.ru"))+"/cgi-bin/readmsg/"+encodeURIComponent(file.name)+"?"+ajs.toQuery(params);patron.Utils.logAPFRequest(result)}}return result},getMp3Url:function(data,file){var result="";if(file.IsMp3){var params={id:file.PartID,mode:"attachment",channel:file.Channel};if(file.ForceAddNotype)params.notype=1;result="//"+data.MailAttachZipHost+"/cgi-bin/readmsg/"+encodeURIComponent(file.name)+"?"+ajs.toQuery(params)}return result},getImagePreviewUrl:function(data,
file,ps,fx,fy){var url="";var params={"x-email":patron.useremail};if(docs.canThumbnail(file.name)&&!file.entry){$.extend(params,{src:file.downloadUrl});if(fx==160&&fy==120)url="//docs."+(patron.SingleDomainName||"mail.ru")+"/preview/160x120/?"+ajs.toQuery(params);else if(arguments.length==3&&ps==90)url="//docs."+(patron.SingleDomainName||"mail.ru")+"/preview/90x90/?"+ajs.toQuery(params);else if(arguments.length==2)url="//docs."+(patron.SingleDomainName||"mail.ru")+"/preview/206x206/?"+ajs.toQuery(params)}else if(apf.canThumbnail(file.name)&&
(file.AddPhoto||file.IsImage&&!file.isTNEF)){$.extend(params,{id:file.PartID,mode:"attachment",channel:file.Channel,bs:file.BodyStart,bl:file.OriginalBodyLen,ct:file.ContentType,cn:file.ContentName,cte:file.ContentEncoding});if(file.ShowThumbnail){params.preview=1;if(patron.exif)params.exif=1}if(ps)params.ps=ps;if(fx)params.fx=fx;if(fy)params.fy=fy;url=patron.IsWinDev||patron.IsDevMyCom?"http://":"//";if(fx||fy)url+=patron.MailAttachPreviewHost||"apf."+(patron.SingleDomainName||"mail.ru");else url+=
data.MailAttachPreviewHost;url+="/cgi-bin/readmsg/"+encodeURIComponent(file.name)+"?"+ajs.toQuery(params);patron.Utils.logAPFRequest(url)}return url},getAllFilesDownloadUrl:function(data){var url="";if(data.AttachAllfiles_name&&data.AttachAllfiles_AttachHost&&data.AttachAllfiles_MsgId&&data.AttachAllfiles_PartsId){var params={id:data.AttachAllfiles_MsgId,"x-email":patron.useremail,partids:data.AttachAllfiles_PartsId,mode:"attachment",fname:data.AttachAllfiles_name};url="//"+data.AttachAllfiles_AttachHost+
"/cgi-bin/getattachment?"+ajs.toQuery(params);patron.Utils.logAPFRequest(url)}return url},getMSVUrl:function(data,file,frame){var result="",type=this.getFileType(file),mode=patron.IsMyCom?"mso":"msv";if(type=="doc"||type=="excel"||type=="pp"){var params={file:file.name,id:file.PartID,mode:mode,tnef_id:file.tnef_id,type:type};if(frame){$.extend(params,{frame:1});result="/cgi-bin/getattach?"+ajs.toQuery(params)}else result="//"+data.MainMailHost+"/cgi-bin/getattach?"+ajs.toQuery(params)}return result},
getMRVUrl:function(data,file,frame){var result="",type=this.getFileType(file);if(type=="doc"||type=="excel"||type=="pp"){var params={file:file.name,id:file.PartID,mode:"mrv",tnef_id:file.tnef_id,type:type};if(frame){$.extend(params,{frame:1});result="/cgi-bin/getattach?"+ajs.toQuery(params)}else result="//"+data.MainMailHost+"/cgi-bin/getattach?"+ajs.toQuery(params)}return result},getFileType:function(file){var type="other",ext=file.ext;if(file.IsImage||file.AddPhoto||ext=="png"||ext=="gif"||ext==
"jpeg"||ext=="jpg"||ext=="bmp"||ext=="tiff"||this.isGraphicPreview(file))type="image";else if(ext=="doc"||ext=="docx"||ext=="wpd"||ext=="wps"||ext=="rtf")type="doc";else if(ext=="xls"||ext=="xlsx"||ext=="xlsb"||ext=="xlsm"||this.isCSVPreview(file))type="excel";else if(ext=="ppt"||ext=="pptx"||ext=="pps"||ext=="ppsx")type="pp";else if(ext=="pdf")type="pdf";else if(ext=="zip"||ext=="rar"||ext=="7z"||file.ContentType=="application/zip"&&file.ext!="docx"&&file.ext!="xlsx"&&file.ext!="pptx"||file.ContentType==
"application/x-rar-compressed")type="archive";else if((file.ContentText||file.entry)&&ext=="txt")type="text";return type},getFileIconType:function(file){var type=file.ext;if(file.IsMp3)type="mp3";else if(file.ContentType=="application/zip"&&file.ext!="docx"&&file.ext!="xlsx"&&file.ext!="pptx")type="zip";else if(file.ContentType=="application/x-rar-compressed")type="rar";return type}});jsLoader.loaded("{patron.attachViewer}patron.FullAttachViewer.Utils")});jsLoader.use(["{plugins}jQueryEvent","{jQuery}jquery.fest-x"],
function(){jsClass.create("patron.FullAttachViewer.Slider").extend(jQueryEvent).statics({iOSDevice:/iPhone|iPod|iPad/i.test(navigator.userAgent),defaultOptions:{slider_max_height:123,slider_show_speed:500,selectedItemClass:"attachviewer__slider__list__item_selected",easing:"swing",speed:500}}).methods({__construct:function(viewer){this.viewer=viewer;this.options=$.extend({},patron.FullAttachViewer.Slider.defaultOptions);this.options.slider_max_height=123;this.FileManager=viewer.FileManager;this.itemWidth=
this.itemHeight=112;this.minOffset=this.maxOffset=0;this.oldOffset=this.offset=this.selectedIndex=0;this.startOffset=undefined;this.$box=$("#AttachViewer");this.$div=$(".js-layerSlider",this.$box).delegate(".js-sliderPrev,.js-sliderNext","click",this._controlClick.bind(this)).delegate(".js-sliderList","click",this._listClick.bind(this));this.$switcher=$(".js-sliderSwitcher",this.$box).bind("click",this._rootClick.bind(this)).bind("mousedown",this._rootMousedown.bind(this));if(patron.FullAttachViewer.Slider.iOSDevice)this.$div.css("height",
this.options.slider_max_height)},initSlider:function(){var dfd=$.Deferred();this.$div.fest("pages/attachviewer/attachviewer__slider",{},function(){this.$inner=$(".js-sliderInner",this.$div);this.$list=$(".js-sliderList",this.$inner);this.$prev=$(".js-sliderPrev",this.$div);this.$next=$(".js-sliderNext",this.$div);this.$div.show();this.itemCount=Math.floor(this.$inner.width()/this.itemWidth);this.$div.hide();this.$inner.css({height:this.itemHeight});this.$switcher.show();dfd.resolve()}.bind(this));
return dfd.promise()},setSelected:function(index){this.selectedIndex=index;this._redrawList(index)},show:function(animate){if(this.visible&&!this.isHideAnimate)return;this.triggerHandler("startShow");this.isHideAnimate=0;this.$div.stop(true,false);if(animate){this.isShowAnimate=1;this.$div.show().animate({height:this.options.slider_max_height},this.options.slider_show_speed,this._showSliderComplete.bind(this))}else{this.visible=1;this.$div.css("height",this.options.slider_max_height).show()}},hide:function(animate){if(!this.visible&&
!this.isShowAnimate)return;this.isShowAnimate=0;this.$div.stop(true,false);if(animate){this.isHideAnimate=1;this.$div.animate({height:0},this.options.slider_show_speed,this._hideSliderComplete.bind(this))}else{this.visible=0;this.$div.hide().css("height",0)}},update:function(){var file=this.FileManager.files.list()[this.offset];this._redrawList(file.index)},_renderList:function(){var that=this,dfd=$.Deferred();this.$list.stop(false,false).css({left:(this.startOffset-this.oldOffset)*this.itemWidth});
this.$list.fest("pages/attachviewer/attachviewer__slider__items",{Files:this.FileManager.files.list(),startOffset:this.startOffset,itemWidth:this.itemWidth,range:[this.offset-this.itemCount,this.offset+this.itemCount*2]},function(){dfd.resolve()}.bind(this));return dfd.then(function(){if(that.$previosSelected)that.$previosSelected.removeClass(that.options.selectedItemClass);that.$previosSelected=that.$list.find('.js-item[data-index="'+that.selectedIndex+'"]').addClass(that.options.selectedItemClass);
that.$list.stop(false,false).animate({left:(that.startOffset-that.offset)*that.itemWidth},that.options.speed,that.options.easing)}).promise()},_getOffsetByIndex:function(index){var offset=this.FileManager.files.getNumber(index);offset-=Math.ceil((this.itemCount-1)/2);return offset<0?0:offset},_redrawList:function(index,direction,limit){var dfd=$.Deferred();this.lastSkipped=this.FileManager.files.skipped();this.FileManager.loader.request(index,direction,limit).done(function(){if(this.FileManager.files.list().length===
0)dfd.reject();else if(this.FileManager.files.total()>1){this.$switcher.addClass("attachviewer__fileinfo_active");if(this.visible||this.isShowAnimate)this.itemCount=Math.floor(this.$inner.css("width","").width()/this.itemWidth);else{this.$div.show();this.itemCount=Math.floor(this.$inner.css("width","").width()/this.itemWidth);this.$div.hide()}this.$inner.css({width:this.itemWidth*this.itemCount});this.maxOffset=Math.max(this.FileManager.files.list().length-this.itemCount,0);this.oldOffset=this.offset;
this.offset=this._normalizeOffset(this._getOffsetByIndex(index));this.startOffset=this.startOffset===undefined?this.offset:this.startOffset+this.lastSkipped-this.FileManager.files.skipped();this._redrawSiblingControl();this._renderList().done(dfd.resolve)}else{this.$switcher.removeClass("attachviewer__fileinfo_active");dfd.resolve()}}.bind(this));return dfd.promise()},_redrawSiblingControl:function(){this.$prev.toggle(this.offset>this.minOffset);this.$next.toggle(this.offset<this.maxOffset)},_normalizeOffset:function(offset){return Math.min(this.maxOffset,
Math.max(offset,this.minOffset))},_setSibling:function(direction){var files=this.FileManager.files.list(),centerFile=files[this.offset+Math.round(this.itemCount/2)],index=this.FileManager.files.getOffsetIndex(centerFile.index,direction,this.itemCount);this._redrawList(index,direction,this.itemCount)},_showSliderComplete:function(){this.isShowAnimate=0;this.visible=1},_hideSliderComplete:function(){this.isHideAnimate=this.visible=0;this.$div.hide()},_rootClick:function(evt){if(!$(evt.target).closest("a",
this.$switcher).length&&this.$switcher.hasClass("attachviewer__fileinfo_active")){this[!this.isHideAnimate&&(this.visible||this.isShowAnimate)?"hide":"show"](true);evt.preventDefault();this.triggerHandler("sliderRootClick");if(this.viewer.file.entry)$.event.trigger("ui-abstract-action",{chain:["archives","viewer","file","show-slider",this.viewer.file.entry.getExtension()]})}},_rootMousedown:function(evt){if($(evt.target).closest("a",this.$switcher).length&&this.$switcher.hasClass("attachviewer__fileinfo_active"))this.triggerHandler("downloadClick")},
_controlClick:function(evt){var $target=$(evt.target);if($target.hasClass("js-sliderPrev")){this._setSibling("prev");this.triggerHandler("prev")}else{this._setSibling("next");this.triggerHandler("next")}},_listClick:function(evt){var $target=$(evt.target);var $item=$target.closest(".js-item",this.$div);if($item.length){this.triggerHandler("click",[$item.data("index")]);evt.preventDefault()}}});jsLoader.loaded("{patron.attachViewer}patron.FullAttachViewer.Slider")});jsLoader.use(["{plugins}jQueryEvent",
"{plugins}Layer","{patron.attachViewer}patron.FullAttachViewer.Slider","{plugins}LayerManager"],function(){jsClass.create("patron.FullAttachViewer.LayerMainDiv").extend(jQueryEvent).statics({defaultOptions:{offset:{top:30,bottom:15}}}).methods({__construct:function(viewer){this.options=$.extend({},patron.FullAttachViewer.LayerMainDiv.defaultOptions);if(patron.NewAttachViewerPopup)this.options.offset.bottom=37;else this.fade=LayerFade.getInstance();this.slider=new patron.FullAttachViewer.Slider(viewer);
this.editors=patron.FullAttachViewer.Editors;this.hideObserver=this.hide.bind(this);this.resizeObserver=this._resize.bind(this);this.controlClickObserver=this._controlClick.bind(this);this.controlMousedownObserver=this._controlMousedown.bind(this);this.reviewClickObserver=this._reviewClick.bind(this);this.$window=$(window);this.$document=$(document);this.$div=$("#AttachViewer");this.$scrollArea=$("body,#ScrollBody");this.$review=$(".js-review",this.$div);this.$close=$(".js-layerClose",this.$div);
this.$prev=$(".js-layerPrev",this.$div);this.$next=$(".js-layerNext",this.$div);this.$name=$(".js-layerNameText",this.$div);this.$nameIcon=$(".js-layerNameIcon",this.$div);this.$pager=$(".js-layerPager",this.$div);this.$downloadLink=$(".js-downloadLink",this.$div);this.$attachToCloudLink=$(".js-attachToCloud",this.$div);this.$editorsLink=$(".js-openWith",this.$div);this.$switchToMsv=$(".js-switchToMsv",this.$div);this.$switchToMrv=$(".js-switchToMrv",this.$div);this.$controls=this.$prev.add(this.$next).add(this.$close);
this.$controls.click(this.controlClickObserver).mousedown(this.controlMousedownObserver);this.$review.click(this.reviewClickObserver);this.$div.delegate(".js-downloadLink","click",function(evt){var $target=$(evt.currentTarget),entry;if($target.is("[data-index]"))entry=viewer.FileManager.files.get($target.attr("data-index")).entry;else if(viewer.file.entry)entry=viewer.file.entry;if(entry)$.event.trigger("ui-abstract-action",{chain:["archives","viewer","file","download",entry.getExtension()]});else if(viewer.file.type===
"archive")$.event.trigger("ui-abstract-action",{chain:["archives","viewer","download"]})});this.$attachToCloudLink.click(function(evt){evt.preventDefault();evt.stopPropagation();var $target=$(evt.currentTarget);LayerManager.show("attachToCloud",[{id:$target.attr("data-id"),name:$target.attr("data-filename")}]);if(viewer.file.type==="archive")$.event.trigger("ui-abstract-action",{chain:["archives","viewer","to-cloud"]})});this.$editorsLink.click(function(evt){var $target;evt.preventDefault();evt.stopPropagation();
$target=$(evt.currentTarget);$target.find(".attachviewer__editor-buble").css("display","none");if($target[0].hasAttribute("data-id")){this.editors.openFileInEditor(evt.currentTarget.getAttribute("data-id"),this.fileData);return}$target.find(".attachviewer__apps-list").toggleClass("attachviewer__apps-list_hidden")}.bind(this));this.$editorsLink.delegate(".attachviewer__apps-list__item","click",function(evt){this.editors.openFileInEditor(evt.currentTarget.getAttribute("data-id"),this.fileData)}.bind(this));
this.$switchToMsv.add(this.$switchToMrv).click(function(e){e.stopPropagation();this.triggerHandler("switchTo")}.bind(this));if(!window.opera&&!!document.createElementNS&&!!document.createElementNS("http://www.w3.org/2000/svg","svg").createSVGRect)this.$div.addClass("svg");if(this.fade)this.fade.bind({hide:this.hideObserver});this.enableHide();Counter.d(1788989)},_resize:function(){this._update();this.slider.update();this.triggerHandler("resize")},_update:function(){var windowHeight=ajs.windowHeight();
var windowWidth=ajs.windowWidth();var scrollTop=ajs.scrollTop();var h=windowHeight-(this.options.offset.top+this.options.offset.bottom);var y=Math.max(scrollTop+this.options.offset.top,scrollTop+(windowHeight-h)/2);if(patron.NewAttachViewerPopup)y=this.options.offset.top;this.$scrollArea.css("overflow",windowWidth>960&&h>500?"hidden":"")},_reviewClick:function(evt){this.triggerHandler("reviewClick")},_controlClick:function(evt){var $target=$(evt.target);if($target.closest(".js-layerClose",this.$div).length){if(!patron.NewAttachViewerPopup)this.hide();
this.triggerHandler("close")}else if($target.closest(".js-layerPrev",this.$div).length)this.triggerHandler("prev");else if($target.closest(".js-layerNext",this.$div).length)this.triggerHandler("next");evt.preventDefault()},_controlMousedown:function(evt){var $target=$(evt.target);if($target.closest(".js-layerClose",this.$div).length){if(!patron.NewAttachViewerPopup)this.hide();this.triggerHandler("closeMousedown")}},show:function(){if(!this.visible){this.visible=1;this.$div.show();if(this.fade)this.fade.show();
this._update();this.$div.addClass("attachviewer_visible");this.$window.bind("resize",this.resizeObserver);this.triggerHandler("show")}return this},hide:function(){if($(".is-copyToCloud_in",".js-layer").is(":visible"))return this;if(this.visible){this.visible=0;if(patron.NewAttachViewerPopup)window.close();else{this.$div.hide();this.$div.removeClass("attachviewer_visible");if(this.fade)this.fade.hide();this.slider.hide();this.$scrollArea.css("overflow","")}this.$window.unbind("resize",this.resizeObserver);
this.triggerHandler("hide")}return this},disableHide:function(){this.fix=1;this.$close.hide();$.hotkeys.off("esc",this.hideObserver);return this},enableHide:function(){this.fix=0;this.$close.show();$.hotkeys.on("esc",this.hideObserver);return this},updateEditorsDropdown:function(editors){this.$editorsLink.css("display",editors.length==0?"none":"inline-block");this.$editorsLink.find(".attachviewer__apps-list").addClass("attachviewer__apps-list_hidden");if(editors.length==0){this.$div.removeClass("attachviewer_editable-attach");
return}else if(editors.length==1)this.$editorsLink.attr("data-id",editors[0].id);else{this.$editorsLink.removeAttr("data-id");this.$editorsLink.find(".attachviewer__apps-list").html(editors.map(function(item){return'<li class="attachviewer__apps-list__item" data-id="'+item.id+'"><ins class="attachviewer__apps-list__item__ico attachviewer__apps-list__item__ico_'+item.id+'"></ins>'+item.title+"</li>"}).join(""))}this.$div.addClass("attachviewer_editable-attach")}});jsClass.create("patron.FullAttachViewer.Layer").extend(jQueryEvent).methods({__construct:function(viewer){this.mainDiv=
new patron.FullAttachViewer.LayerMainDiv(viewer);this.hideObserver=this.hide.bind(this);this.$div=$(".js-layerInner",this.mainDiv.$div);this.mainDiv.bind({hide:this.hideObserver})},show:function(){if(!this.visible){this.visible=1;this.$div.show();this.mainDiv.show();this.triggerHandler("show")}return this},hide:function(){if(this.visible){this.visible=0;this.$div.hide();this.mainDiv.hide();this.triggerHandler("hide")}return this}});jsLoader.loaded("{patron.attachViewer}patron.FullAttachViewer.Layer")});
jsLoader.use(["{jQuery}jquery"],function(){jsClass.create("patron.FullAttachViewer.Preload").statics({files:[],init:function(index,parent){try{var files=this.files.splice(index<=0?0:index-1,3);files.splice(1,1);this.preload(files)}catch(error){}},preload:function(files){if(!files.length)return-1;var namespace="preloadIMG-"+$.expando;if(!$(namespace)[0])$("<div />",{id:namespace}).hide().appendTo("body");$.each(files,function(){$("<img />",{src:this}).appendTo("#"+namespace)});return 0}});jsLoader.loaded("{patron.attachViewer}patron.FullAttachViewer.Preload")});
jsLoader.use(["{patron.v2}attachment/Attachment","{patron.v2}utils/contentTypes"],function(Attachment,contentTypes){var archives={};function _prepareItems(items){var results=[];var lang=Lang.get("attachment-browser");Array.forEach(items,function(entry){var result={kind:entry.kind,name:entry.name};if(entry.kind==="directory"){result.mods=["closed-folder"];result.actions=[{name:lang.expand,classes:"js-expand"},{name:lang.collapse,classes:"js-collapse"}]}else{var downloadUrl=entry.getDownloadUrl();var viewerUrl=
entry.getViewerUrl();var actions=[{name:lang.download,href:downloadUrl,classes:"js-download"}];if(viewerUrl)actions.unshift({name:lang.preview,href:viewerUrl,classes:"js-link"});var data={};if(contentTypes.is("archive",entry.contentType)){actions.unshift({name:lang.expand,classes:"js-expand"},{name:lang.collapse,classes:"js-collapse"});data.hash=entry.parentArchive.hash;data.pathHash=entry.pathHash;archives[data.hash+data.pathHash]=entry}result.size=String.sizeFormat(entry.size);result.downloadUrl=
downloadUrl;result.viewerUrl=viewerUrl;result.mods=[contentTypes.getCategory(entry.contentType)];result.actions=actions;result.data=data}var contents=entry.getContents&&entry.getContents();if(contents)result.list={items:_prepareItems(contents)};results.push(result)});return results}jsClass.create("patron.FullAttachViewer.Archive").methods({__construct:function($expandable,parameters){var t=this;this._$expandable=$expandable;this._data={status:"loading"};this._render();var entry;if(parameters.id)try{entry=
(new Attachment(parameters.messageId,parameters.id.split(";").slice(1))).rootEntry}catch(e){this._fail("")}else if(parameters.hash&&parameters.pathHash)entry=archives[parameters.hash+parameters.pathHash];if(entry&&entry.kind==="archive")entry.requestContents().then(function(contents){t._update("done",contents)}).fail(function(){t._fail("")});else this._fail("")},_render:function(){var t=this;t._$expandable.fest("pages/attachment-browser",t._data);t._$expandable.find(".js-expandable, .js-collapse").display("none")},
_update:function(status,items){var t=this;t._data.status=status;if(t._data.items);else{t._data.items=_prepareItems(items);t._render()}},_fail:function(message){var t=this;t._data.status="error";t._data.message=message;t._render()}});jsLoader.loaded("{patron.attachViewer}patron.FullAttachViewer.Archive")});jsLoader.use([],function(){jsClass.create("patron.FullAttachViewer.CloudPopup").methods({__construct:function(params){this.file=params.file;this.editor=params.editor;this.notShowPopup=store.get(patron.useremail+
"|editors.popup.notshow");this.needAcceptLA=!(patron.CommonPurposeBitmask>>15&1);if(this.notShowPopup){this.openCopyPage();return}LayerManager.show("copyToCloud",{file:this.file,editor:params.editor,needAcceptLA:this.needAcceptLA,initCallback:this._initLayer.bind(this)});$.event.trigger("ui-abstract-action",{chain:["editors","cloudpopup","show"]})},_initLayer:function(layer){var $continueButton=layer.$el.find(".continue"),$agreeCheckBox;this.layer=layer;if(this.needAcceptLA){$agreeCheckBox=layer.$el.find(".js-im-agree");
$agreeCheckBox.bind("change",function(evt){patron.toolkit.toggleMod($continueButton,"disabled",!$agreeCheckBox.is(":checked"))})}$continueButton.bind("click",function(evt){if(patron.toolkit.hasMod($continueButton,"disabled"))return;if($agreeCheckBox&&$agreeCheckBox.is(":checked"))patron.CommonPurposeBitmask=patron.CommonPurposeBitmask|1<<15;if(layer.$el.find(".js-notshow").is(":checked"))store.set(patron.useremail+"|editors.popup.notshow",true);this.openCopyPage()}.bind(this));(function(){var switchers=
layer.$el.find(".js-popup__content-switcher"),slides=layer.$el.find(".js-popup__body__slides__item"),slidesContainer=slides.parent(),slideW=layer.$el.find(".js-popup__body__slides__item").eq(0).width();switchers.find(".popup__content-switcher__text").bind("click",function(e){var $link=$(e.currentTarget).parent(),curIndex=$link.attr("data-slide-to")*1,nextIndex=curIndex+1<switchers.length?curIndex+1:0;slidesContainer.stop(true).animate({left:-1*nextIndex*slideW+"px"},250);$link.removeClass("active");
switchers.eq(nextIndex).addClass("active");e.preventDefault()})})();if(!window.opera&&!!document.createElementNS&&!!document.createElementNS("http://www.w3.org/2000/svg","svg").createSVGRect)layer.$el.addClass("svg")},openCopyPage:function(){window.open("/cgi-bin/lstatic?get=openInCloud&attachId="+this.file.id+"&editorId="+this.editor.id+(this.needAcceptLA?"&needAcceptLa=yes":""));$.event.trigger("ui-abstract-action",{chain:["editors","cloudpopup","continue"]});$.event.trigger("ui-abstract-action",
{chain:["editors","cloudpopup","continue_"+this.file.ext]});if(this.layer)this.layer.hide()}});jsLoader.loaded("{patron.attachViewer}patron.FullAttachViewer.CloudPopup")});jsLoader.use(["{patron.attachViewer}patron.FullAttachViewer.CloudPopup"],function(){jsClass.create("patron.FullAttachViewer.Editors").statics({editors:{"MailPad":{"title":"\u0420\u0435\u0434\u0430\u043a\u0442\u043e\u0440 Mail.Ru","titleGenitive":"\u0420\u0435\u0434\u0430\u043a\u0442\u043e\u0440\u0430 Mail.Ru","id":"MailPad","description":"\u041d\u043e\u0432\u043e\u0435 \u043f\u0440\u0438\u043b\u043e\u0436\u0435\u043d\u0438\u0435 Mail.Ru \u0434\u043b\u044f \u0440\u0435\u0434\u0430\u043a\u0442\u0438\u0440\u043e\u0432\u0430\u043d\u0438\u044f \u0434\u043e\u043a\u0443\u043c\u0435\u043d\u0442\u043e\u0432 Word. \u0414\u043e\u0441\u0442\u0443\u043f\u043d\u0430 \u0430\u043b\u044c\u0444\u0430-\u0432\u0435\u0440\u0441\u0438\u044f \u0441 \u0431\u0430\u0437\u043e\u0432\u044b\u043c \u0444\u0443\u043d\u043a\u0446\u0438\u043e\u043d\u0430\u043b\u043e\u043c",
"edit_extensions":["docx","doc"],"isAvailable":patron.enableEditMailpad,"appUrl":"https://cloud.mail.ru/edit/mailpad/home#{id}"},"Owa":{"title":"Microsoft Office Web App","id":"Owa","description":"\u041e\u043d\u043b\u0430\u0439\u043d-\u0432\u0435\u0440\u0441\u0438\u044f Microsoft Office, \u043f\u043e\u0437\u0432\u043e\u043b\u044f\u044e\u0449\u0430\u044f \u0440\u0435\u0434\u0430\u043a\u0442\u0438\u0440\u043e\u0432\u0430\u0442\u044c \u043f\u0440\u0435\u0437\u0435\u043d\u0442\u0430\u0446\u0438\u0438 PowerPoint \u0438 \u0442\u0430\u0431\u043b\u0438\u0446\u044b Excel",
"edit_extensions":["xls","xlsx","ppt","pptx"],"isAvailable":patron.enableEditOwa,"appUrl":"https://cloud.mail.ru/edit/owa/home#{id}"},"Libre":{"title":"Libre Office","id":"Libre","description":"\u041e\u043d\u043b\u0430\u0439\u043d-\u0432\u0435\u0440\u0441\u0438\u044f \u043f\u043e\u043f\u0443\u043b\u044f\u0440\u043d\u043e\u0433\u043e \u043e\u0444\u0438\u0441\u043d\u043e\u0433\u043e \u043f\u0430\u043a\u0435\u0442\u0430, \u0430\u043d\u0430\u043b\u043e\u0433\u0438\u0447\u043d\u043e\u0433\u043e Microsoft Office. \u0412\u0435\u0440\u0441\u0438\u044f \u043f\u0440\u0435\u0434\u043e\u0441\u0442\u0430\u0432\u043b\u0435\u043d\u0430 \u0441\u0435\u0440\u0432\u0438\u0441\u043e\u043c rollApp.com",
"edit_extensions":["xls","xlsx","ppt","pptx","doc","docx"],"isAvailable":patron.enableEditLibre,"appUrl":"https://cloud.mail.ru/edit/libre/home#{id}"}},getEditorsForExt:function(ext){var id,editors=this.editors,res=[];for(id in editors)if(editors[id].isAvailable&&editors[id].edit_extensions.indexOf(ext)!=-1)res.push(editors[id]);return res},openFileInEditor:function(editor,file){$.event.trigger("ui-abstract-action",{chain:["editors","open",editor]});this.popup=new patron.FullAttachViewer.CloudPopup({"editor":this.editors[editor],
"file":file})},getEditorUrl:function(file,editor){var folder=encodeURI(file.folder=="/"?"/":file.folder+"/"),fileId=folder+encodeURIComponent(file.name);return String.supplant(this.editors[editor].appUrl,{"id":fileId})}});jsLoader.loaded("{patron.attachViewer}patron.FullAttachViewer.Editors")});define("{patron.attachViewer}patron.FullAttachViewer.EditorsPromo",["{patron.attachViewer}patron.FullAttachViewer.Editors"],function(){var EditorsPromo=function($el){this.$el=$(".b-layer_editors-promo");this.$bubleEl=
$(".attachviewer__editor-buble");this.$el.find(".btn_layer_close, .b-layer__overlay, .js-external-editors-promo__thanks").click(this.close.bind(this));this.$spot=this.$el.find(".js-external-editors-promo__spot");this.$el.find(".external-editors-promo__fakebutton").click(this.openEditor.bind(this));this.$el.find(".external-editors-promo__app-selector").delegate(".external-editors-promo__app-item","click",function(evt){var $el=$(evt.currentTarget);$el.siblings().removeClass("external-editors-promo__app-item_selected");
$el.addClass("external-editors-promo__app-item_selected");this.selectedEditor=$el[0].getAttribute("data-app");patron.toolkit.toggleMod(this.$el.find(".b-layer__controls__buttons .btn_main")[0],"disabled",false);return false}.bind(this));this.$el.find(".b-layer__controls__buttons .btn_main").click(function(){if(this.selectedEditor){patron.FullAttachViewer.Editors.openFileInEditor(this.selectedEditor,this.file);this.close()}}.bind(this));this.$bubleEl.click(function(evt){evt.stopPropagation();this.hideBuble()}.bind(this));
var $openWithLink=$(".js-openWith"),spotH=this.$spot.height(),$window=$(window);var spotReposition=function(){var linkOffset=$openWithLink.offset();this.$spot.css({left:linkOffset.left-13,top:linkOffset.top-spotH+22+$window.scrollTop(),opacity:1})}.bind(this);$window.bind("resize.spot scroll.spot attachViewerRedraw.attachViewer",spotReposition.debounce(100))};EditorsPromo.prototype.openEditor=function(evt){if(this.availableEditors.length>1){this.$el.removeClass("b-layer_editors-promo_black");this.$el.find(".external-editors-promo").display("none");
var container=this.$el.find(".b-layer__container");container.display(true);if(patron.TestAnimations)container.toggleMod("open",true)}else if(this.availableEditors.length==1){patron.FullAttachViewer.Editors.openFileInEditor(this.availableEditors[0].id,this.file);this.close()}$.event.trigger("ui-abstract-action",{chain:["editorspromo","edit"]});evt.stopPropagation()};EditorsPromo.prototype.showIfNeed=function(file,availableEditors){var viewedExtensions;this.availableEditors=availableEditors;this.file=
{id:file.PartID,name:file.name,ext:file.ext};this.hideBuble();if(patron.enableEditorsPromo&&availableEditors&&availableEditors.length>0){viewedExtensions=store.get(patron.useremail+"|editors.promo.ext")||[];if(viewedExtensions.indexOf(file.ext)==-1){if(store.get(patron.useremail+"|editors.promo.layer"))this.showBuble(file.ext);else{if(availableEditors.length>1)$.fest("blocks/fullattachviewer/promo-apps-list",{editors:availableEditors},function(html){this.$el.find(".external-editors-promo__app-list").html(html)}.bind(this));
this.open();store.set(patron.useremail+"|editors.promo.layer",true)}viewedExtensions.push(file.ext);store.set(patron.useremail+"|editors.promo.ext",viewedExtensions)}}};EditorsPromo.prototype.showBuble=function(ext){this.$bubleEl.find(".file-icon")[0].className="file-icon file-icon_type_"+ext;this.$bubleEl.css("display","block");$.event.trigger("ui-abstract-action",{chain:["editorspromo","showbuble",ext]})};EditorsPromo.prototype.hideBuble=function(ext){this.$bubleEl.css("display","none")};EditorsPromo.prototype.open=
function(){$.event.trigger("ui-abstract-action",{chain:["editorspromo","show"]});this.$el.display(true);if(patron.TestAnimations)this.$el.toggleMod("editors-promo_open",true)};EditorsPromo.prototype.close=function(){if(patron.TestAnimations){this.$el.find(".b-layer__container").toggleMod("open",false).toggleMod("close",true);this.$el.bind("animationend webkitAnimationEnd MSAnimationEnd oAnimationEnd",function(){this.$el.display(false)}.bind(this));this.$el.toggleMod("editors-promo_open",false).toggleMod("editors-promo_close",
true)}else this.$el.display(false)};patron.FullAttachViewer.EditorsPromo=EditorsPromo});if(!("ajs"in window))ajs={};(function(ajs){var PDF={};var hasReaderActiveX=function(){var axObj=null;if(window.ActiveXObject){try{axObj=new ActiveXObject("AcroPDF.PDF")}catch(e){}if(!axObj)try{axObj=new ActiveXObject("PDF.PdfCtrl")}catch(e){}if(axObj!==null)return true}return false};var hasReader=function(){if(navigator.plugins){var i,n=navigator.plugins,count=n.length,regx=/Adobe Reader|Adobe PDF|Acrobat/gi;for(i=
0;i<count;i++)if(regx.test(n[i].name))return true}return false};var hasGeneric=function(){var plugin=navigator.mimeTypes["application/pdf"];return plugin&&plugin.enabledPlugin};var pluginFound=function(){var type=null;if(hasReader()||hasReaderActiveX())type="Adobe";else if(hasGeneric())type="generic";return type};var embed=function(targetID,options){if(PDF.disabled)return false;options=options||{};options.url=options.url||"";options.width=options.width||"100%";options.height=options.height||"100%";
var targetNode=targetID.nodeType&&targetID.nodeType===1?targetID:document.getElementById(targetID);if(!targetNode)return false;targetNode.innerHTML='<object\tdata="'+options.url+'" type="application/pdf" width="'+options.width+'" height="'+options.height+'"></object>';return targetNode.getElementsByTagName("object")[0]};PDF.type=pluginFound();PDF.disabled=!PDF.type;PDF.embed=embed;if(window.$&&$.browser&&$.browser.mozilla&&parseInt($.browser.version,10)>18)PDF.disabled=false;ajs.PDF=PDF})(ajs);jsLoader.loaded("{utils}PDF");
jsLoader.use(["{patron.v2}attachment/Attachment","{patron.v2}utils/contentTypes","{patron}patron.BindedCounters","{patron}patron.Balloon","{patron.attachViewer}patron.FullAttachViewer.Utils","{patron.attachViewer}patron.FullAttachViewer.Layer","{patron.attachViewer}patron.FullAttachViewer.Slider","{patron.attachViewer}patron.FullAttachViewer.Preload","{patron.attachViewer}patron.FullAttachViewer.Archive","{patron.attachViewer}patron.FullAttachViewer.Editors","{patron.attachViewer}patron.FullAttachViewer.EditorsPromo",
"{utils}PDF","{utils}jsHistory","{jQuery}jquery.tpl","{jQuery}jquery.fest-x"],function(Attachment,contentTypes){var FileManager=function(viewer){var _files=new FileMap;var _loader=new FileLoader;function FileLoader(){var _limit=patron.AttachViewerPreloadLimit;var _normalize={index:function(index,limit){if(ajs.isset(limit)){index=_normalize.index(index);limit=_normalize.limit(limit);index=Math.min(_files.total(),index+limit)-limit}else index=Math.min(_files.total()-1,Math.max(index,0));return index},
limit:function(limit){return Math.min(_files.total(),Math.max(limit,0))}};var _validator={index:function(index){return index===_normalize.index(index)}};function load(data){var params=$.extend({},GET,data),dfd=$.Deferred();patron.Messages.loadFilesSearch(params,true).done(function(params,res){var fragment=[];Array.forEach(res.data.list,function(file,index){var is_image=file.content_type_id===1;fragment.push({index:params.offset+index,file:{Subject:file.subject,name:file.name,FromShort:file.from_to_name,
IsImage:is_image,ShowThumbnail:is_image,MessageID:[file.id].concat(file.n.slice(0,-2)).join(";"),PartID:[file.id].concat(file.n).join(";"),size:file.size}})});_files.addFragment(fragment);_files.total(res.data.total);_files.skipped(params.offset);dfd.resolve(res)}.bind(null,params));return dfd.promise()}function fetch(index,direction,limit){var dfd=$.Deferred(),params={},start=index,end=index;if(direction==="next")end+=limit;else if(direction==="prev")start-=limit;else{end+=+limit||0;start-=+limit||
0}end=_normalize.index(end);start=_normalize.index(start);for(var i=start,l=end,item;i<=l;i++){item=_files.get(i);if(!item)break}if(item)dfd.resolve();else{params.limit=_normalize.limit(_limit);if(direction==="next")params.offset=start;else if(direction==="prev")params.offset=end-_limit+1;else{params.offset=start-_limit;params.limit=_normalize.limit(_limit*2)}params.offset=_normalize.index(params.offset,params.limit);load(params).done(dfd.resolve)}return dfd.promise()}function request(index,direction,
limit){var that=this,deferred=$.Deferred(),file,tail=[];function retry(){that.request(index).then(function(file){deferred.resolve(file)})}function process(file){if(!patron.NewArchivePreview||!tail.length)deferred.resolve(file);else expandArchive(file,indexes.join(";")).then(retry)}indexes=Array.map((""+index).split(";"),function(index){return+index||0});var offset=indexes[0];while(indexes.length&&!(file=_files.get(indexes.join(";"))))tail.unshift(indexes.pop());if(viewer.options.filesearch)this.fetch(offset,
direction,limit).then(file?function(){process(file)}:retry);else if(file)process(file);return deferred}function expandArchive(file,index,fromCache){var that=this,deferred=$.Deferred();function expand(entry){entry.requestContents({fromCache:fromCache}).done(function(contents){var currentIndex=0,fragment=[];Array.forEach(entry.getEntries(),function(entry){if(entry.kind!=="directory")fragment.push({index:index+";"+currentIndex++,file:viewer.toOldFormat(entry)})});_files.addFragment(fragment);_files.total(_files.total()+
fragment.length);deferred.resolve(contents)}).fail(function(){deferred.reject()})}if(file.entry)expand(file.entry);else{var partIds=file.PartID.replace(file.MessageID+";","").split(";");Attachment.getFromMessage(file.MessageID,partIds).then(function(attachment){expand(attachment.rootEntry)})}return deferred}return{fetch:fetch,request:request,expandArchive:expandArchive,validator:_validator,normalize:_normalize}}function FileMap(){var _map={},_fragments=[],_total=Infinity,_skipped=Infinity;function combineFragments(){var elements=
[],fragmentId=0;Array.forEach(arguments,function(fragments){Array.forEach(fragments,function(fragment){Array.forEach(fragment,function(id){elements.push({id:""+id,fragmentId:fragmentId})});fragmentId++})});elements.sort(function(a,b){var idA=a.id.split(";"),idB=b.id.split(";"),i=0;while(idA[i]==idB[i]&&idA[i]!==undefined)i++;return(+idA[i]+1||0)-(+idB[i]+1||0)});var fragments=[],fragmentsList=[],fragmentsMap={},elementsMap={},currentFragmentId;function mergeFragments(fragmentA,fragmentB){if(fragmentA.elements!==
fragmentB.elements){Array.prototype.push.apply(fragmentB.elements,fragmentA.elements);fragmentA.elements=fragmentB.elements}}Array.forEach(elements,function(element){if(element.fragmentId!==currentFragmentId){if(fragmentsMap[element.fragmentId])mergeFragments(fragmentsMap[currentFragmentId],fragmentsMap[element.fragmentId]);else fragmentsMap[element.fragmentId]={number:Object.keys(fragmentsMap).length,elements:[]};currentFragmentId=element.fragmentId}if(elementsMap[element.id]!==undefined)mergeFragments(fragmentsMap[elementsMap[element.id]],
fragmentsMap[element.fragmentId]);else elementsMap[element.id]=element.fragmentId;if(!Array.contains(fragmentsMap[element.fragmentId].elements,element.id))fragmentsMap[element.fragmentId].elements.push(element.id)});Object.forEach(fragmentsMap,function(fragment){fragmentsList.push(fragment)});fragmentsList.sort(function(a,b){return a.number-b.number});Array.forEach(fragmentsList,function(fragment){if(!Array.contains(fragments,fragment.elements))fragments.push(fragment.elements)});return fragments}
function getIndexes(){return Array.prototype.concat.apply([],_fragments)}return{addFragment:function(fragment){var ids=[];Array.forEach(fragment,function(element){var file=viewer.utils.createFileDescription(viewer.data,element.file,element.index);patron.FullAttachViewer.Preload.files.push(file.imageUrl);_map[element.index]=file;ids.push(element.index)});_fragments=combineFragments(_fragments,[ids])},add:function(file,index){this.addFragment([{index:index,file:file}]);return file},get:function(index){return _map[index]},
getNumber:function(index){var number=Array.indexOf(getIndexes(),""+index);return number<0?undefined:number},getOffsetIndex:function(index,direction,offset){var indexes=getIndexes(),newOffset=this.getNumber(index)+(direction==="prev"?-offset:offset);if(newOffset>=indexes.length)newOffset=indexes.length-1;if(newOffset<0)newOffset=0;return indexes[newOffset]},list:function(){return Array.map(getIndexes(),function(index){return _map[index]})},map:function(){return _map},clear:function(){_map={};_fragments=
[];_total=Infinity;_skipped=Infinity},total:function(total){return ajs.isset(total)?_total=total:_total},skipped:function(skipped){return ajs.isset(skipped)?_skipped=Math.min(_skipped,skipped):_skipped}}}return{files:_files,loader:_loader}};jsClass.create("patron.FullAttachViewer.Viewer").statics({defaultOptions:{isShort:!patron.AttachViewStyle,preview_list_tmpl_id:"#AttachViewer__previewList_ejs",preview_short_list_tmpl_id:"#AttachViewer__previewShortList_ejs",archive_tree_tmpl_id:"attachviewer__archive__tree",
type_other_tmpl_id:"attachviewer__other",type_image_tmpl_id:"attachviewer__image",type_text_tmpl_id:"attachviewer__text",type_pdf_tmpl_id:"attachviewer__pdf",type_msdoc_tmpl_id:"attachviewer__MSDoc",type_archive_tmpl_id:"attachviewer__archive"}}).methods({__construct:function(options){this.options=$.extend({},patron.FullAttachViewer.Viewer.defaultOptions,options);this.utils=patron.FullAttachViewer.Utils;this.editors=patron.FullAttachViewer.Editors;this.isShort=this.options.isShort;this.$window=$(window);
this.$document=$(document);this.FileManager=new FileManager(this);this.links=[];this.layerGeometry={width:0,height:0};this.layerCache={};this.imageData={}},_initialize:function(){this.listClickObserver=this._listClick.bind(this);this.listMouseDownObserver=this._listClick.bind(this,true);this.switcherClickObserver=this._switcherClick.bind(this);this.innerMouseMoveObserver=this._innerMouseMove.bind(this);this.imageClickObserver=this._imageClickObserver.bind(this);this.resizeControlClickObserver=this._resizeControlClickObserver.bind(this);
this.resizeControlHoverObserver=this._resizeControlHoverObserver.bind(this);this.keyNavigationObserver=this._keyNavigationObserver.bind(this);this.loadPlayerClickObserver=this._loadPlayerClick.bind(this);if(!this.options.popup){this.documentClickObserver=this._documentClick.bind(this);this.beforeUnloadObserver=this._beforeUnload.bind(this)}this.layer=new patron.FullAttachViewer.Layer(this);this.layer.mainDiv.bind("prev next close closeMousedown hide show resize subjectClick reviewClick, switchTo",
{scope:this},function(evt){var scope=evt.data.scope,type=evt.type;if(type=="prev"){scope._setSibling(type);scope.$window.triggerHandler("attachViewerPreviewPrevClick.attachViewer")}else if(type=="next"){scope._setSibling(type);scope.$window.triggerHandler("attachViewerPreviewNextClick.attachViewer")}else if(type=="close")setTimeout(function(){scope.$window[0].close()},200);else if(type=="closeMousedown")scope.$window.triggerHandler("attachViewerPreviewCloseClick.attachViewer");else if(type=="show"){scope.$document.bind("click",
scope.documentClickObserver).bind("keydown",scope.keyNavigationObserver);scope.$window.bind("beforeunload",scope.beforeUnloadObserver)}else if(type=="hide"){if(scope.$previosLayer&&scope.removePrevios)scope.$previosLayer.remove();scope.$document.unbind("click",scope.documentClickObserver).unbind("keydown",scope.keyNavigationObserver);scope.$window.unbind("beforeunload",scope.beforeUnloadObserver);jsHistory.set(jsHistory.get().replace(/([&\?]_av=)[^&]+/,"$1"),null,true)}else if(type=="resize")scope._resize();
else if(type=="subjectClick")scope.$window.triggerHandler("attachViewerSubjectClick.attachViewer");else if(type==="reviewClick"){var upload_src=patron.FullAttachViewer.ExtViewerSrc;if(upload_src)(new Image).src=upload_src.replace("/upload/","/report/")}else if(type==="switchTo"){var src;if(scope.file.mode==="msv"){src=scope.utils.getMRVUrl(scope.data,scope.file,true);scope.file.mode="mrv"}else{src=scope.utils.getMSVUrl(scope.data,scope.file,true);scope.file.mode="msv"}var $iframe=scope.layer.mainDiv.$div.find(".js-msdocIframe:visible");
if($iframe)$iframe.attr("src",src);scope._updateMSDocSwitcher()}if(type!="resize")patron.FullAttachViewer.Preload.init(scope.index,this.layer)});this.layer.mainDiv.slider.bind("startShow click prev next sliderRootClick downloadClick",{scope:this},function(evt,index){var scope=evt.data.scope,type=evt.type;if(type=="prev")scope.$window.triggerHandler("attachViewerSliderPrevClick.attachViewer");else if(type=="next")scope.$window.triggerHandler("attachViewerSliderNextClick.attachViewer");else if(type==
"click"){if(index!=scope.index)scope.setFile(index);scope.$window.triggerHandler("attachViewerSliderListClick.attachViewer")}else if(type=="startShow")scope.$resizeControl.hide();else if(type=="sliderRootClick")scope.$window.triggerHandler("attachViewerSliderRootClick.attachViewer");else if(type=="downloadClick")scope._count(scope.FileManager.files.get(scope.index),true,true)});this.$resizeControl=$(".js-layerResize",this.layer.mainDiv.$div).bind({"mouseover mouseout":this.resizeControlHoverObserver,
"click":this.resizeControlClickObserver,"mousedown":false});this.isInitialize=1},redraw:function(selector,data,builded){this.destroy();this.setData({message:data,files:data.Attachments,links:data.Attachlinks});var isReadMsgPage=patron.isReadMsgPage(),hasArchives=false;Array.forEach(data.Attachments,function(attachment){if(isReadMsgPage&&contentTypes.is("archive",attachment.ContentType))hasArchives=true});hasArchives&&$.event.trigger("ui-abstract-action",{chain:["archives","readmsg","has"]});if(this.data.NewAttachViewer)this.$container=
$(selector).bind("click",this.listClickObserver).bind("mousedown",this.listMouseDownObserver).delegate(".js-switcher","click",this.switcherClickObserver);if(!builded)this.drawTemplate();if(this.isShort&&patron.AudioPlayerApi)this.$container.find(".js-loadplayer, .js-play").bind("click",this.loadPlayerClickObserver);if(!patron.IsCorpUser)this.$container.find(".filesearch__thumbnail__icon_doc, .filesearch__thumbnail__icon_docx, .filesearch__thumbnail__icon_xls, .filesearch__thumbnail__icon_xlsx, .filesearch__thumbnail__icon_ppt, .filesearch__thumbnail__icon_pptx").children(".filesearch__thumbnail__preview").hide()},
_setSibling:function(direction){this.setFile(this.FileManager.files.getOffsetIndex(this.index,direction,1),direction,0)},initViewer:function(index){var that=this;if(!this.isInitialize)this._initialize();return this.layer.mainDiv.slider.initSlider().done(function(){that._showFile(index);that.$window.triggerHandler("attachViewerRedraw.attachViewer",[that.FileManager.files.list(),that.links])})},toOldFormat:function(entry){var viewUrl=entry.getViewUrl();var downloadUrl=entry.getDownloadUrl();var fileData=
{entry:entry,disableAttachToCloud:true,name:entry.name,size:entry.size,PartID:entry.getKey(),IsMp3:entry.is("audio"),downloadUrl:downloadUrl,downloadFromZipUrl:downloadUrl,imageUrl:viewUrl,notypeInFrameUrl:viewUrl,previewMSVUrl:entry.viewUrl,previewMRVUrl:entry.viewUrl,mp3Url:downloadUrl};if(entry.is("image"))fileData.previewUrl=entry.getPreviewUrl();var file=this.utils.createFileDescription(this.data,fileData);file.index=entry.getIndex().join(";");return file},setData:function(data){if(!this.isInitialize)this._initialize();
this.layerGeometry={width:0,height:0};this.layerCache={};this.imageData={};this.FileManager.files.clear();this.links=[];this.data=$.extend({AvStatusBar:patron.AvStatusBar,NewAttachViewer:patron.NewAttachViewer,Id:"",Subject:"",FromShort:"",files_status:"",MainMailHost:"",MailAttachZipHost:"",MailAttachPreviewHost:"",AttachAllfiles_name:"",AttachAllfiles_AttachHost:"",AttachAllfiles_MsgId:"",AttachAllfiles_PartsId:"",Winmail_IsRtf:0,Winmail_name:"",Winmail_Channel:"",Winmail_PartID:"",Winmail_hasAttach:0,
Winmail_size:0,Winmail_URLFileName:""},data.message);if(!this.data.Subject)this.data.Subject="&lt;"+Lang.get("message.email.untitled")+"&gt;";this.data.Subject=replaceEntity(this.data.Subject);this.data.FromShort=replaceEntity(this.data.FromShort);this.data.archiveDownloadUrl=this.utils.getAllFilesDownloadUrl(this.data);this.data.MailAttachPreviewHost=String(this.data.MailAttachPreviewHost).replace(/^af\w*\./,"apf.");if(data.files||data.links){var total=0,fragment=[];Array.forEach(data.files,function(item,
index){fragment.push({index:this.utils.getAttachIndex(item,this.data.id),file:$.extend(item,{MessageID:this.data.id})});total++;if(!this.options.popup)this._count(item)},this);this.FileManager.files.addFragment(fragment);this.FileManager.files.total(total);this.FileManager.files.skipped(0);Array.forEach(data.links,function(item,index){this.links.push(this.utils.createLinkDescription(this.data,item,index))},this)}},_count:function(file,isAttachViewer,isClick){var type="other",typeWithPreview="otherNoPreview",
counters={"image":1788014,"text":1788019,"archive":1788029,"doc":1788035,"excel":1788037,"pp":1788039,"pdf":1788042,"audio":1788044,"video":1788046,"ai":1788049,"psd":1788051,"other":1788053},countersWithPreview={"imagePreview":[1788056,1789120],"imageNoPreview":[1788057,1789168],"textPreview":[1788058,1789121],"textNoPreview":[1788061,1789173],"archiveNoPreview":[1788063,1789174],"docPreview":[1788064,1789123],"docNoPreview":[1788065,1789175],"excelPreview":[1788067,1789124],"excelNoPreview":[1788068,
1789176],"ppPreview":[1788069,1789125],"ppNoPreview":[1788070,1789177],"pdfPreview":[0,1789127],"pdfNoPreview":[1788075,1789178],"audioPreview":[1788078,1789130],"audioNoPreview":[1788080,1789179],"videoNoPreview":[1788084,1789180],"aiPreview":[1788086,1789133],"aiNoPreview":[1788088,1789181],"psdPreview":[1788092,1789134],"psdNoPreview":[1788094,1789182],"otherPreview":[1788097,1789135],"otherNoPreview":[1788099,1789183]};if(file.imageUrl&&!this.utils.isGraphicPreview(file)){type="image";typeWithPreview=
"imagePreview"}else if((file.ext=="tga"||file.ext=="tif"||file.ext=="tiff")&&!this.utils.isGraphicPreview(file)){type="image";typeWithPreview="imageNoPreview"}else if(file.type=="text"){type="text";typeWithPreview=(this.isShort||isAttachViewer)&&file.ContentText?"textPreview":"textNoPreview"}else if(file.type=="archive"){type="archive";typeWithPreview="archiveNoPreview"}else if(file.type=="doc"){type="doc";typeWithPreview=this.utils.isOfficePreview(file)||isAttachViewer?"docPreview":"docNoPreview"}else if(file.type==
"excel"){type="excel";typeWithPreview=this.utils.isOfficePreview(file)||isAttachViewer?"excelPreview":"excelNoPreview"}else if(file.type=="pp"){type="pp";typeWithPreview=this.utils.isOfficePreview(file)||isAttachViewer?"ppPreview":"ppNoPreview"}else if(file.type=="pdf"){type="pdf";typeWithPreview=isAttachViewer&&!ajs.PDF.disabled?"pdfPreview":"pdfNoPreview"}else if(file.IsMp3||file.ext=="ram"||file.ext=="midi"||file.ext=="wav"||file.ext=="ogg"||file.ext=="aiff"||file.ext=="flac"||file.ext=="m4a"||
file.ext=="wma"){type="audio";typeWithPreview=file.IsMp3&&(this.isShort||isAttachViewer)?"audioPreview":"audioNoPreview"}else if(file.ext=="flv"||file.ext=="vmv"||file.ext=="mpg"||file.ext=="3gp"||file.ext=="mov"||file.ext=="asf"||file.ext=="mp4"||file.ext=="mpeg"||file.ext=="avi"){type="video";typeWithPreview="videoNoPreview"}else if(file.ext=="ai"||file.ext=="eps"){type="ai";typeWithPreview=this.utils.isGraphicPreview(file)?"aiPreview":"aiNoPreview"}else if(file.ext=="psd"){type="psd";typeWithPreview=
this.utils.isGraphicPreview(file)?"psdPreview":"psdNoPreview"}else{type="other";typeWithPreview=this.utils.isGraphicPreview(file)||this.utils.isCSVPreview(file)?"otherPreview":"otherNoPreview"}if(!isClick){if(!!~typeWithPreview.indexOf("NoPreview")){Counter.d(1788231);if(patron["LogNoPreview"]){var _log={log:"attachesnopreview",ext:file.ext,isattachviewer:isAttachViewer?"1":"0",isreadmsg:patron.isReadMsg?"1":"0"};(new Image).src="//gstat."+patron.staticDomainName+"/gstat?ua=1&logme="+encodeURIComponent($.param(_log))+
"&r="+Math.random()}}else Counter.d(1788232);if(!isAttachViewer)Counter.d(counters[type]);Counter.d(countersWithPreview[typeWithPreview][isAttachViewer?1:0])}else if(isAttachViewer)Counter.sb(countersWithPreview[typeWithPreview][1])},_bindOnHistoryChange:function(){var that=this;jsHistory.change(function(hash,force,data){var offset=0,matches,part_id;if(data)offset=data.offset;else if(matches=hash.match(/[&\?]offset=([^&]+)/))offset=decodeURIComponent(matches[1]);else if(matches=hash.match(/[&\?]_av=([^&]+)/)){offset=
part_id=decodeURIComponent(matches[1]);if(that.data.Attachments)Array.some(that.data.Attachments,function(item,index){var result=part_id===item.PartID||part_id==index;if(result)offset=item.PartID.replace(that.data.id+";","")+(item.isTNEF?";"+item.tnef_id:"");return result})}that._showFile(offset)},true)},drawTemplate:function(){var templateId=this.isShort?this.options.preview_short_list_tmpl_id:this.options.preview_list_tmpl_id;this.$container.tpl(templateId,$.extend({},this.data,{Attachments:this.FileManager.files.list(),
Attachlinks:this.links}));if(patron.isThumb2Active)if(!this.isShort){patron.toolkit["b-thumb-2"].watch(this.$container,".b-thumb-2",[{width:"1010",thumbCount:3},{width:"1070",thumbCount:4},{width:"1360",thumbCount:5},{width:"1800",thumbCount:6}]);patron.toolkit["b-thumb-2"].loadPreviews(this.$container)}else patron.toolkit["b-thumb-2"].unwatch(this.$container)},_updateMSDocSwitcher:function(){var type=this.file.type,isMsdoc=type=="doc"||type=="excel"||type=="pp",enabled=patron.MSDocViewerSwitch&&
(!$.browser.msie||parseInt($.browser.version,10)>8)&&isMsdoc&&!this.file.entry;this.layer.mainDiv.$switchToMsv.display(enabled&&this.file.mode!=="msv");this.layer.mainDiv.$switchToMrv.display(enabled&&this.file.mode!=="mrv")},_showFile:function(index){var dfd=$.Deferred();if(!this.bindOnHistoryChange){this.bindOnHistoryChange=1;this._bindOnHistoryChange()}this.FileManager.loader.request(index).then(function(file){var layer=this.layer;var layerMainDiv=layer.mainDiv;var iconType="other";var fileIconType=
this.utils.getFileType(file);clearTimeout(this.imageMouseMoveTimeout);clearTimeout(this.imageResizeTimeout);this.scroll=false;this.index=index;this.number=this.FileManager.files.getNumber(index);this.file=file;this.type=this.utils.getFileType(file);this.data.Subject=file.Subject||this.data.Subject;this.data.FromShort=file.FromShort||this.data.FromShort;if(this.type=="image")iconType="photo";else if(this.type=="doc"||this.type=="excel"||this.type=="pp")iconType="doc";else if(fileIconType=="mp3")iconType=
"music";if(this.type=="image")this.scroll=!!(this.imageData[this.index]&&this.imageData[this.index].scroll);this.$resizeControl.toggleClass("attachviewer__resize_minus",this.scroll).hide();layer.$div.toggleClass("attachviewer__inner_scroll",this.scroll);layer.$div.removeClass("attachviewer__inner_hidden-overflow");layer.show();layerMainDiv.$prev.toggle(this.number>0);layerMainDiv.$next.toggle(this.number<this.FileManager.files.total()-1);if(patron.v2)layerMainDiv.$nameIcon.replaceClass(/\s*ico_attachviewer_filetype_[^\s]+/,
"").addClass("ico_attachviewer_filetype_"+iconType);else layerMainDiv.$nameIcon.replaceClass(/\s*icon_type\-[^\s]+/,"").addClass("icon_type-"+iconType);layerMainDiv.$name.text(file.isRFC822?ajs.HTML.unescape(file.name):file.name);layerMainDiv.$downloadLink.attr("href",file.downloadUrl);layerMainDiv.$attachToCloudLink.attr("data-id",file.PartID);layerMainDiv.$attachToCloudLink.attr("data-filename",file.isRFC822?ajs.HTML.unescape(file.name):file.name);layerMainDiv.$attachToCloudLink.display(!file.disableAttachToCloud);
layerMainDiv.fileData={id:file.PartID,name:file.isRFC822?ajs.HTML.unescape(file.name):file.name,ext:file.ext};layerMainDiv.$pager.text(this.number+this.FileManager.files.skipped()+1+" "+Lang.get("attachViewer.paging.from")+" "+this.FileManager.files.total());this._create(this.index,this.type,file);this._title();$(this).triggerHandler("showFile",file);if(!patron.IsMyCom)if(patron["IsMRVReviewEnabled"]&&this._isMRVReview(file.ext)){if($(this).triggerHandler("review",["mr-office",file])!==false)layerMainDiv.$review.attr("href",
layerMainDiv.$review.data("link-mr")+"?file="+encodeURIComponent(file.downloadUrl)).show()}else if(patron["IsMSVReviewEnabled"]&&this._isMSVReview(file.ext)){if($(this).triggerHandler("review",["ms-office",file])!==false)layerMainDiv.$review.attr("href",layerMainDiv.$review.data("link-ms")+"?file="+encodeURIComponent(file.downloadUrl)).show()}else if($(this).triggerHandler("review",["file",file])!==false)layerMainDiv.$review.hide();layerMainDiv.slider.hide();layerMainDiv.slider.setSelected(index);
this.initExternalEditors(file);this._updateMSDocSwitcher();dfd.resolve();if(this.file.entry)$.event.trigger("ui-abstract-action",{chain:["archives","viewer","file","show",this.file.entry.getExtension()]})}.bind(this));return dfd.promise()},setFile:function(index,direction,limit){this.FileManager.loader.request(index,direction,this.layer.mainDiv.slider.itemCount).done(function(file){var host=location.protocol+"//"+location.host;var url=jsHistory.get().replace(/[&\?]id=[^&]+/,"").replace(/[&\?]_av=[^&]+/,
"").replace(/[&\?]offset=[^&]+/,"").replace(new RegExp("^(("+String.preg_quote(host)+")?/cgi-bin/)?"),"").replace(/\/&/,"/?");url+=url.indexOf("?")===-1?"?":"&";url+="offset="+index+"&id="+this.data.Id+"&_av="+(file.isTNEF?index:file.PartID);jsHistory.set(url,{offset:index},true);this._count(this.FileManager.files.get(index),true)}.bind(this))},setMode:function(isShort){if(isShort!=this.isShort){this.isShort=isShort;this.drawTemplate();if(isShort&&patron.AudioPlayerApi)this.$container.find(".js-loadplayer, .js-play").bind("click",
this.loadPlayerClickObserver);patron.Ajax({type:"POST",url:"/cgi-bin/ajax_modifyprofile?ajax_call=1&func_name="+(isShort?"new_attach_viewer_off":"new_attach_viewer_on")})}},_title:function(){var data={name:this.file.isRFC822?ajs.HTML.unescape(this.file.name):this.file.name,subject:this.data.Subject,email:patron.useremail};document.title=Lang.get("title.ajax_attach_action").replace(/#(\w+)#/gi,function(a,key){return data[key]||""})},_create:function(index,type,file){var options=this.options,event;
var templateId=options.type_other_tmpl_id;var templateData=$.extend(true,{},{data:this.data,file:file});var isMsdoc=type=="doc"||type=="excel"||type=="pp";var isPDF=type=="pdf"&&!ajs.PDF.disabled;if(file.ext==="csv"&&!patron["IsMRVCsvEnabled"])isMsdoc=false;var $inner=this.layerCache[index];if(this.$previosLayer)this.$previosLayer[this.removePrevios?"remove":"hide"]();if($inner)$inner.show();else{$inner=$("<div/>",{width:"100%",height:"100%"}).appendTo(this.layer.$div);if(!(isMsdoc||isPDF))this.layerCache[index]=
$inner;if(type=="image")templateId=options.type_image_tmpl_id;else if(type=="text")templateId=options.type_text_tmpl_id;else if(isPDF)templateId=options.type_pdf_tmpl_id;else if(isMsdoc){var mode="msv";templateId=options.type_msdoc_tmpl_id;var forceMSV=!!$.browser.msie&&parseInt($.browser.version,10)<=8||!!GET.forcemsv&&patron.IsForceMSVEnabled;if(patron["IsMRVMSDocEnabled"]&&!forceMSV&&type=="doc"&&(file.ext=="doc"||file.ext=="docx")||patron["IsMRVMSExcelEnabled"]&&!forceMSV&&type=="excel"&&(file.ext==
"xls"||file.ext=="xlsx")||patron["IsMRVCsvEnabled"]&&!forceMSV&&file.ext=="csv"||patron["IsMRVRtfEnabled"]&&!forceMSV&&file.ext=="rtf"||patron["IsMRVMSPptEnabled"]&&!forceMSV&&(file.ext=="pptx"||file.ext=="ppt"))mode="mrv";file.mode=file.mode||mode;$.extend(templateData,{previewMSVUrl:file.entry?file.previewMSVUrl:this.utils.getMSVUrl(this.data,file,true),previewMRVUrl:file.entry?file.previewMRVUrl:this.utils.getMRVUrl(this.data,file,true),mode:file.mode});if(type=="doc")event="showWord.officeWebApps";
else if(type=="excel")event="showExcel.officeWebApps";else if(type=="pp")event="showPowerPoint.officeWebApps"}else if(type=="archive")templateId=options.type_archive_tmpl_id;if(event)this.$window.triggerHandler(event);templateData.mail=this.data;templateData.lang=Lang.get("Attachviewer");$inner.fest("pages/attachviewer/"+templateId,templateData,function(){if(type=="image"){var $viewer=$(".js-image-viewer",$inner);var $image=$("img",$viewer);$viewer.addClass("attachviewer__viewer_image_loading");if(this.imageData[this.index]&&
this.imageData[this.index].geometry)$inner.bind("mousemove",this.innerMouseMoveObserver);else{var eventData={index:this.index,container:$inner};if($image&&$image[0])if($image[0].complete)this._imageLoad({target:$image[0],data:eventData});else $image.bind("load",eventData,this._imageLoad.bind(this))}if(this.number<this.FileManager.files.total()-1)$viewer.bind("click",this.imageClickObserver);else $viewer.addClass("attachviewer__viewer_disabled")}else if(!patron["IsMRVMSDocEnabled"]&&type=="doc"&&patron.IsCorpUser){if(this.$testframe)this.$testframe.remove();
this.$testframe=$('<iframe src="'+this.utils.getMRVUrl(this.data,file,true)+'"/>').hide().appendTo(document.body)}else if(!patron["IsMRVMSExcelEnabled"]&&type=="excel"&&patron.IsCorpUser){if(this.$testframe)this.$testframe.remove();this.$testframe=$('<iframe src="'+this.utils.getMRVUrl(this.data,file,true)+'"/>').hide().appendTo(document.body)}else if(type=="archive"){$inner.delegate(".js-ViewSource","click",function(e){var that=this,$viewSource=$inner.find(".js-ViewSource");$viewSource.addClass("attachviewer__viewer__show-source_loading");
function renderTree(tree){var treeWrapper=$inner.find(".attachviewer__viewer__archive-files");treeWrapper.fest("pages/attachviewer/"+options.archive_tree_tmpl_id,{files:tree,lang:templateData.lang},function(){$inner.addClass("attachviewer__inner_archive-source");var rowHeight=treeWrapper.find(".messageline:first").height();treeWrapper.delegate(".js-toggle-folder","click",function(){var $item=$(this),$file=$item.closest(".messagelist_fileslist_short__files__file"),$files=$item.closest(".messagelist_fileslist_short__files"),
id=$item.attr("data-id");var node=tree.get(id);node.toggleOpen();if(!node.childrenRendered)$file.find(".messagelist_fileslist_short__files__wrapper").fest("pages/attachviewer/"+options.archive_tree_tmpl_id+"__list",{files:node,lang:templateData.lang},function(){node.childrenRendered=true});$item.attr("title",$(this).attr(node.isOpen?"data-hide-title":"data-show-title"));$item.find(".messageline__filetype__icon").toggleClass("icon_filetype_folder icon_filetype_folder_opened");$file.toggleClass("messagelist_fileslist_short__files__file_folder messagelist_fileslist_short__files__file_folder_opened");
$item.parents(".messageline").each(function(i,row){var $row=$(row),id=$row.find(".js-toggle-folder:first").attr("data-id");$row.height(tree.getVisibleNodesCount(id)*(rowHeight+1))})});if(patron.NewArchivePreview)treeWrapper.delegate(".js-show","click",function(e){that.setFile($(this).attr("data-index"));e.preventDefault();e.stopPropagation()});$inner.find(".js-archive-viewer").removeClass("attachviewer__viewer_archive_loading")}.bind(this))}function renderFail(){$viewSource.display("none");$inner.find(".js-error").html(Lang.get("Attachviewer").blocks.attaches.archive.cannot_view).display("");
$inner.find(".js-archive-viewer").removeClass("attachviewer__viewer_archive_loading")}function mimicAttzipFolder(contents){var result={};Array.forEach(contents,function(entry){if(entry.kind==="directory")result[entry.name+"/"]=mimicAttzipFolder(entry.getContents());else{var file=that.toOldFormat(entry);if(that.options.filesearch)file.index=file.index.replace(entry.attachment.partIds.join(";"),that.index);result[entry.name]=[entry.size,0,entry.getPath(),null,file]}});return result}if(patron.NewArchivePreview)this.FileManager.loader.expandArchive(this.file,
this.file.index).then(function(contents){var R=[null,null,[that.file.PartID,mimicAttzipFolder(contents)]];var tree=that.utils.createFilesTree(that.data,R);renderTree(tree);that.layer.mainDiv.slider.update();$.event.trigger("ui-abstract-action",{chain:["archives","viewer","listed"]})}).fail(renderFail);else $.getJSON('/cgi-bin/att_zip?ajax_call=1&func_name=zip_list&data=["'+this.file.PartID+'"]&token='+window["mailru_api_token"],function(R){if(R[1]=="OK"&&R[2]&&R[2][0]!=null&&typeof R[2][1]==="object"){var tree=
this.utils.createFilesTree(this.data,R);renderTree(tree);Counter.d(1789122)}else renderFail()}.bind(this));$.event.trigger("ui-abstract-action",{chain:["archives","viewer","expand"]})}.bind(this));if(patron.AutoshowArchiveContents){$inner.find(".js-archive-viewer").addClass("attachviewer__viewer_archive_loading");$inner.find(".js-ViewSource").click()}}else if(patron.AudioPlayerApi)$inner.find(".js-play").bind("click",{file:file,noPlay:true},this.loadPlayerClickObserver).triggerHandler("click");$inner.delegate(".js-attachToCloud",
"click",function(evt){evt.preventDefault();evt.stopPropagation();var $target=$(evt.currentTarget);LayerManager.show("attachToCloud",[{id:$target.attr("data-id"),name:$target.attr("data-filename")}])});$(".js-subject",$inner).mousedown(function(){this.layer.mainDiv.triggerHandler("subjectClick")}.bind(this))}.bind(this))}this.$previosLayer=$inner;this.removePrevios=isMsdoc||isPDF;this._resize()},_keyNavigationObserver:function(evt){var key=evt.keyCode;if(key==37||key==39){this.layer.mainDiv.trigger(key==
37?"prev":"next");evt.preventDefault()}},_resizeControlHoverObserver:function(evt){clearTimeout(this.imageMouseMoveTimeout);clearTimeout(this.imageResizeTimeout);this.$resizeControl.stop(true,false);if(evt.type=="mouseover")this.$resizeControl.css("opacity",0.5).show();else this.$resizeControl.css("opacity",0.3)},_resizeControlClickObserver:function(evt){var $image=$("img",this.$previosLayer);this.layer.$div.toggleClass("attachviewer__inner_scroll",this.scroll=!this.scroll);if(this.scroll){$image.css({"max-width":"",
"max-height":""});this.$window.triggerHandler("attachViewerResizeClick.attachViewer")}else{$image.css({"max-width":this.layerGeometry.width,"max-height":this.layerGeometry.height});this.$window.triggerHandler("attachViewerResizeMinusClick.attachViewer")}if(!this.imageData[this.index])this.imageData[this.index]={};this.imageData[this.index].scroll=this.scroll;this.$resizeControl.toggleClass("attachviewer__resize_minus",this.scroll);evt.stopPropagation()},_imageClickObserver:function(evt){this.layer.mainDiv.trigger("next");
this.$window.triggerHandler("attachViewerPreviewImageClick.attachViewer")},_innerMouseMove:function(evt){if(this.imageData[this.index]&&this.imageData[this.index].geometry)if(this.imageData[this.index].geometry[0]>this.layerGeometry.width||this.imageData[this.index].geometry[1]>this.layerGeometry.height){clearTimeout(this.imageMouseMoveTimeout);this.imageMouseMoveTimeout=setTimeout(function(){this.$resizeControl.stop(true,false).css("opacity",0.3).show();clearTimeout(this.imageResizeTimeout);this.imageResizeTimeout=
setTimeout(function(){this.$resizeControl.animate({opacity:0},700,function(){this.$resizeControl.hide()}.bind(this))}.bind(this),2E3)}.bind(this),10)}},_listClick:function(){var ismousedown=arguments.length==2,evt=ismousedown?arguments[1]:arguments[0];var $target=$(evt.target),event;var $item=$target.closest(".js-item",this.$container);var $link=$target.closest(".js-link",$item);var $forcemsv=$target.closest(".js-forcemsv",$item);var $download=$target.closest(".js-download",$item);var $downloadAll=
$target.closest(".js-downloadAll",$item);var $attachToCloud=$target.closest(".js-attachToCloud",$item);var $attachAllToCloud=$target.closest(".js-attachAllToCloud",$item);var $expand=$target.closest(".js-expand",$item);var $collapse=$target.closest(".js-collapse",$item);if($item.length&&($link.length||$download.length||$attachToCloud.length||$expand.length||$collapse.length)){var file=Array.filter(this.FileManager.files.list(),function(file){if(file.isTNEF)return file.PartID===$item.attr("data-id")&&
file.tnef_id===$item.attr("data-tnef-id");return file.PartID===$item.attr("data-id")})[0];if(file){var index=file.index;var type=this.utils.getFileType(file)}if(file&&!ismousedown&&!$download.length&&!$attachToCloud.length&&!$expand.length&&!$collapse.length&&$link.length){if(!$link.is("a")){var url=this.utils.getAttachPreviewUrl(this.data,file,index);try{var w=open(url);w.focus()}catch(e){}}this.$window.triggerHandler("attachViewerListClick.attachViewer");if(type=="doc")event="clickWordLink.officeWebApps";
else if(type=="excel")event="clickExcelLink.officeWebApps";else if(type=="pp")event="clickPowerPointLink.officeWebApps";if(event)this.$window.triggerHandler(event)}if(file&&ismousedown){var counters={"image":[1788014,1788015],"text":[1788019,1788021],"archive":[1788029,1788034],"doc":[1788035,1788036],"excel":[1788037,1788038],"pp":[1788039,1788040],"pdf":[1788042,1788043],"audio":[1788044,1788045],"video":[1788046,1788047],"ai":[1788049,1788050],"psd":[1788051,1788052],"other":[1788053,1788054]};
if(type=="other")if(file.IsMp3||file.ext=="ram"||file.ext=="midi"||file.ext=="wav"||file.ext=="ogg"||file.ext=="aiff"||file.ext=="flac"||file.ext=="m4a"||file.ext=="wma")type="audio";else{if(file.ext=="flv"||file.ext=="vmv"||file.ext=="mpg"||file.ext=="3gp"||file.ext=="mov"||file.ext=="asf"||file.ext=="mp4"||file.ext=="mpeg"||file.ext=="avi")type="video"}else if(type=="image")if(file.ext=="ai"||file.ext=="eps")type="ai";else if(file.ext=="psd")type="psd";if(counters[type])if($download.length)Counter.sb(counters[type][1]);
else Counter.sb(counters[type][0]);if($download.length){$.event.trigger("ui-abstract-action",{chain:["attachment","download",this.isShort?"from-list":"from-thumbnails"]});if(type==="archive")$.event.trigger("ui-abstract-action",{chain:["archives","readmsg","download",this.isShort?"from-list":"from-thumbnails"]})}else if($link.length&&!$attachToCloud.length){$.event.trigger("ui-abstract-action",{chain:["attachment","preview",this.isShort?"from-list":"from-thumbnails"]});if(type==="archive")$.event.trigger("ui-abstract-action",
{chain:["archives","readmsg","preview",this.isShort?"from-list":"from-thumbnails"]})}if($forcemsv.length)$.event.trigger("ui-abstract-action",{chain:["forcemsv","click"]})}else{if($attachToCloud.length){evt.preventDefault();evt.stopPropagation();LayerManager.show("attachToCloud",[{id:$attachToCloud.attr("data-id"),name:$attachToCloud.attr("data-filename")}]);if(type==="archive")$.event.trigger("ui-abstract-action",{chain:["archives","readmsg","to-cloud",this.isShort?"from-list":"from-thumbnails"]})}if(patron.NewArchivePreview&&
($expand.length||$collapse.length)){evt.preventDefault();evt.stopPropagation();if($expand.length)this._expandItem($expand.closest(".js-item"),true);else this._expandItem($collapse.closest(".js-item"),false)}}}if(evt.type==="click"&&$attachAllToCloud.length){evt.preventDefault();evt.stopPropagation();LayerManager.show("attachToCloud",$attachAllToCloud.data("files"))}if(evt.type==="mousedown"&&$downloadAll.length)$.event.trigger("ui-abstract-action",{chain:["attachment","download","all"]})},_expandItem:function($item,
expand){var $name=$item.find(".js-name, .ohd").first(),$expandable=$name.siblings(".js-expandable"),$meta=$name.siblings(".js-meta, .js-info"),$expand=$meta.find(".js-expand"),$collapse=$meta.find(".js-collapse");if(expand){if(!$expandable.length){$expandable=$('<div class="attachment-browser__item__expandable js-expandable">').insertAfter($name);new patron.FullAttachViewer.Archive($expandable,{messageId:$item.closest(".js-attachments-view").attr("data-message-id"),id:$item.attr("data-id"),hash:$item.attr("data-hash"),
pathHash:$item.attr("data-path-hash")})}$expandable.add($collapse).display("");$expand.display("none");$.event.trigger("ui-abstract-action",{chain:["archives","readmsg","expand",this.isShort?"from-list":"from-thumbnails"]})}else{$expandable.add($collapse).display("none");$expand.display("");$.event.trigger("ui-abstract-action",{chain:["archives","readmsg","collapse",this.isShort?"from-list":"from-thumbnails"]})}},_switcherClick:function(evt){var isShort=!this.isShort;this.setMode(isShort);if(!patron.IsCorpUser)this.$container.find(".filesearch__thumbnail__icon_doc, .filesearch__thumbnail__icon_docx, .filesearch__thumbnail__icon_xls, .filesearch__thumbnail__icon_xlsx, .filesearch__thumbnail__icon_ppt, .filesearch__thumbnail__icon_pptx, .filesearch__thumbnail__icon_pdf").children(".filesearch__thumbnail__preview").hide();
this.$window.triggerHandler("attachViewerChangeModeClick.attachViewer",[isShort])},_imageLoad:function(evt){var target=evt.target,$target=$(target),index=evt.data.index;if(!this.imageData[index])this.imageData[index]={};this.imageData[index].geometry=[target.naturalWidth||target.width,target.naturalHeight||target.height];evt.data.container.bind("mousemove",this.innerMouseMoveObserver);this._resize();evt.data.container.find(".js-image-viewer").removeClass("attachviewer__viewer_image_loading");$target.css("visibility",
"visible")},_loadPlayerClick:function(evt){evt.preventDefault();ajs.require(["{plugins}"+"AudioPlayer"],function(){var $Elm=$(evt.target).closest(".js-attachAudio, .js-info").find(".js-player");var file=evt.data?evt.data.file:null;var noPlay=evt.data?evt.data.noPlay:false;var options={noPlay:noPlay};if(file)options.url=file.mp3Url;$Elm.audioPlayer(options)});Counter.sb(1788078)},_documentClick:function(evt){var mainDiv=this.layer.mainDiv;if(!$(evt.target).closest(".js-layerWrap",mainDiv.$div).length)this.layer.hide()},
_beforeUnload:function(evt){return Lang.get("attachViewer.before_unload_confirm")},_resize:function(){this.layerGeometry={width:this.layer.$div.width(),height:this.layer.$div.height()};this.$resizeControl.hide();if(this.type=="image"){if(!this.scroll){var $image=$("img",this.$previosLayer);$image.css({"max-width":this.layerGeometry.width,"max-height":this.layerGeometry.height})}}else if(this.type=="doc"||this.type=="excel"||this.type=="pp")$(".attachviewer__viewer__wrap",this.$previosLayer).css("height",
this.layerGeometry.height);else if(this.type=="pdf")if($.browser.msie){var wrapHeight=this.layerGeometry.height-this.layer.mainDiv.slider.options.slider_max_height;if(parseInt($.browser.version)<8)wrapHeight-=1;$(".attachviewer__viewer_pdfwrap",this.$previosLayer).css("height",wrapHeight)}},_isMRVReview:function(ext){return(ext=="doc"||ext=="docx")&&patron.IsMRVMSDocEnabled||(ext=="xls"||ext=="xlsx")&&patron.IsMRVMSExcelEnabled||(ext=="ppt"||ext=="pptx")&&patron.IsMRVMSPptEnabled||(ext=="xls"||ext==
"xlsx")&&patron.IsMRVCsvEnabled||ext=="csv"&&patron.IsMRVCsvEnabled||ext=="rtf"&&patron.IsMRVRtfEnabled},_isMSVReview:function(ext){return(ext=="doc"||ext=="docx")&&!patron.IsMRVMSDocEnabled||(ext=="xls"||ext=="xlsx")&&!patron.IsMRVMSExcelEnabled||(ext=="ppt"||ext=="pptx")&&!patron.IsMRVMSPptEnabled||(ext=="xls"||ext=="xlsx")&&!patron.IsMRVCsvEnabled||ext=="csv"&&!patron.IsMRVCsvEnabled||ext=="rtf"&&!patron.IsMRVRtfEnabled},initExternalEditors:function(file){var availableEditors=this.editors.getEditorsForExt(file.ext);
this.layer.mainDiv.updateEditorsDropdown(availableEditors);if(availableEditors.length){if(!this.editorsPromo)this.editorsPromo=new patron.FullAttachViewer.EditorsPromo;this.editorsPromo.showIfNeed(file,availableEditors)}},destroy:function(){if(this.$container){this.$container.unbind("click",this.listClickObserver);this.$container.undelegate(".js-switcher","click",this.switcherClickObserver)}}});jsLoader.loaded("{patron.attachViewer}patron.FullAttachViewer.Viewer")});jsLoader.use(["{festTemplate}pages/attachviewer/attachviewer__archive__tree",
"{festTemplate}pages/attachviewer/attachviewer__archive","{festTemplate}pages/attachviewer/attachviewer__image","{festTemplate}pages/attachviewer/attachviewer__MSDoc","{festTemplate}pages/attachviewer/attachviewer__other","{festTemplate}pages/attachviewer/attachviewer__pdf","{festTemplate}pages/attachviewer/attachviewer__slider","{festTemplate}pages/attachviewer/attachviewer__slider__items","{festTemplate}pages/attachviewer/attachviewer__text","{patron.attachViewer}patron.FullAttachViewer.Viewer",
"{patron.v2.utils}patron.utils.ui.counters"],function(){jsLoader.loaded("{patron.build}AttachViewer",0)});window.$=window.jQuery=jQuery})(window.patron&&patron.jQuery||window.jQuery);
